<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Black Sheep Restaurants - Beverage Database</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SheetJS for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        /* Theme 1 - Original Orange Theme */
        .theme-orange {
            --primary: #2C3E50;
            --secondary: #34495E;
            --accent: #E67E22;
            --accent-light: #F39C12;
            --accent-soft: rgba(230,126,34,0.1);
            --accent-hover: #d35400;
            --success: #27AE60;
            --danger: #E74C3C;
            --warning: #F1C40F;
            --light: #ECF0F1;
            --dark: #1E2B36;
            --white: #FFFFFF;
            --gray: #95A5A6;
            --sidebar-width: 280px;
            --profit: #27AE60;
            --loss: #E74C3C;
            --sheep-black: #1a1a1a;
        }

        /* Theme 2 - Light Blue Theme */
        .theme-blue {
            --primary: #2C3E50;
            --secondary: #34495E;
            --accent: #3498db;
            --accent-light: #5dade2;
            --accent-soft: rgba(52,152,219,0.1);
            --accent-hover: #2980b9;
            --success: #27AE60;
            --danger: #E74C3C;
            --warning: #F1C40F;
            --light: #ECF0F1;
            --dark: #1E2B36;
            --white: #FFFFFF;
            --gray: #95A5A6;
            --sidebar-width: 280px;
            --profit: #27AE60;
            --loss: #E74C3C;
            --sheep-black: #1a1a1a;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Sync Status Indicator */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--white);
            border-radius: 30px;
            font-size: 0.875rem;
            color: var(--gray);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .sync-status.synced {
            color: var(--success);
        }

        .sync-status.syncing {
            color: var(--accent);
            animation: spin 1s linear infinite;
        }

        .sync-status.offline {
            color: var(--danger);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Theme Toggle Button */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            background: var(--white);
            padding: 0.5rem;
            border-radius: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .theme-toggle-btn {
            padding: 0.5rem 1rem;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--gray);
        }

        .theme-toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        .theme-toggle-btn i {
            margin-right: 0.25rem;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1002;
            background: var(--accent);
            color: var(--white);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            color: var(--dark);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-header {
            margin-bottom: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--sheep-black);
        }

        .logo span {
            font-size: 2rem;
        }

        .restaurant-badge {
            background: var(--accent-soft);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            color: var(--accent);
            border: 1px solid rgba(230,126,34,0.3);
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .nav-item i {
            width: 24px;
            text-align: center;
            color: var(--accent);
        }

        .favorites-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .favorites-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .content-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        /* Header */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            color: var(--dark);
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Search Bar */
        .search-container {
            display: flex;
            align-items: center;
            background: var(--white);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            width: 400px;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .search-container i {
            color: var(--gray);
            margin-right: 0.5rem;
        }

        .search-container input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.95rem;
            background: transparent;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 0.5rem;
        }

        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: var(--accent-soft);
        }

        .search-result-category {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            font-weight: 600;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--white);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--light);
            transform: translateX(-4px);
        }

        /* Alphabet Navigation */
        .alphabet-nav-container {
            display: flex;
            gap: 2rem;
            position: relative;
        }

        .alphabet-content {
            flex: 1;
        }

        .alphabet-nav {
            position: sticky;
            top: 2rem;
            right: 0;
            float: right;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background: var(--white);
            padding: 1rem 0.5rem;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-left: 1rem;
            z-index: 10;
        }

        .alphabet-letter {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .alphabet-letter:hover {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .alphabet-letter.active {
            background: var(--accent);
            color: white;
        }

        .alphabet-letter.disabled {
            opacity: 0.3;
            cursor: default;
        }

        .alphabet-letter.disabled:hover {
            background: none;
            color: var(--gray);
        }

        /* Quick Search */
        .quick-search {
            display: flex;
            align-items: center;
            background: var(--white);
            border-radius: 30px;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .quick-search i {
            color: var(--gray);
            margin-right: 0.5rem;
        }

        .quick-search input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
            background: transparent;
        }

        /* Spirit Library Styles */
        .spirit-library-container {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .import-section {
            background: var(--accent-soft);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px dashed var(--accent);
            text-align: center;
        }

        .import-area {
            border: 2px dashed var(--gray);
            border-radius: 12px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-area:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .spirit-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--light);
            padding: 0.5rem 1rem;
            border-radius: 30px;
            flex: 1;
            min-width: 250px;
        }

        .filter-group i {
            color: var(--accent);
        }

        .filter-input {
            border: none;
            background: transparent;
            padding: 0.5rem;
            outline: none;
            width: 100%;
        }

        .spirit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .spirit-table th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
        }

        .spirit-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .spirit-table tr:hover {
            background: var(--accent-soft);
        }

        .spirit-actions {
            display: flex;
            gap: 0.5rem;
        }

        .spirit-edit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .spirit-edit-btn:hover {
            background: var(--secondary);
        }

        .spirit-delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .spirit-delete-btn:hover {
            background: #c0392b;
        }

        .abv-spirit {
            color: var(--success);
            font-weight: 600;
        }

        .abv-liqueur {
            color: #e67e22;
            font-weight: 600;
        }

        .abv-bitters {
            color: #9b59b6;
            font-weight: 600;
        }

        .abv-wine {
            color: #3498db;
            font-weight: 600;
        }

        .abv-non {
            color: var(--gray);
            font-weight: 400;
        }

        /* Spirit Edit Modal */
        .spirit-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .spirit-edit-content {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Ingredient Autocomplete */
        .ingredient-search {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .autocomplete-item:hover {
            background: var(--accent-soft);
        }

        /* Venue Grid */
        .venue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .venue-card {
            background: var(--white);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .venue-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px var(--accent-soft);
            border-color: var(--accent);
        }

        .venue-drag-handle {
            position: absolute;
            top: 1rem;
            left: 1rem;
            cursor: move;
            color: var(--gray);
        }

        .venue-image {
            width: 100%;
            height: 160px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .venue-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .venue-image-upload {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .venue-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .venue-name-large {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .venue-location {
            color: var(--gray);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .venue-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .venue-stat {
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .venue-stat:hover {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .venue-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            width: 100%;
        }

        .venue-action-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .venue-edit-btn {
            background: var(--primary);
            color: white;
        }

        .venue-edit-btn:hover {
            background: var(--secondary);
        }

        .venue-delete-btn {
            background: var(--danger);
            color: white;
        }

        .venue-delete-btn:hover {
            background: #c0392b;
        }

        .venue-overview-btn {
            background: var(--accent);
            color: white;
        }

        .venue-overview-btn:hover {
            background: var(--accent-light);
        }

        /* Item Cards - Used for both venue cocktails and classic cocktails */
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .item-card, .classic-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .item-card:hover, .classic-card:hover {
            background: var(--accent-soft);
            transform: translateX(4px);
            border-color: var(--accent);
        }

        .item-thumbnail, .classic-image {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .item-thumbnail img, .classic-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info, .classic-info {
            flex: 1;
        }

        .item-name, .classic-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .item-meta, .classic-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--gray);
            align-items: center;
            flex-wrap: wrap;
        }

        .item-badge, .classic-price-badge {
            background: var(--accent-soft);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent);
        }

        .family-tag {
            background: var(--accent-soft);
            padding: 0.15rem 0.5rem;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--accent);
            display: inline-block;
        }

        .action-btn, .classic-action-btn {
            background: none;
            border: 1px solid var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--primary);
            margin-left: 0.5rem;
        }

        .action-btn:hover, .classic-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        .share-btn, .classic-share-btn {
            border-color: var(--accent);
            color: var(--accent);
        }

        .share-btn:hover, .classic-share-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .favorite-star {
            color: var(--accent);
            margin-left: 0.25rem;
        }

        /* Overview Menu Styles */
        .overview-container {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            margin-top: 1.5rem;
        }

        .overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
        }

        .overview-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .overview-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .selection-actions {
            display: flex;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        .select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .overview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .overview-table th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
        }

        .overview-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.875rem;
        }

        .overview-table tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .overview-table tr:hover {
            background: var(--accent-soft);
        }

        .overview-table tr.selected {
            background: rgba(230,126,34,0.15);
            border-left: 3px solid var(--accent);
        }

        .cogs-good {
            color: var(--success);
            font-weight: 600;
        }

        .cogs-warning {
            color: #F39C12;
            font-weight: 600;
        }

        .cogs-high {
            color: var(--danger);
            font-weight: 600;
        }

        .editable-price {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .editable-price:hover {
            background-color: var(--accent-soft);
        }

        .price-input {
            width: 80px;
            padding: 0.25rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-size: 0.875rem;
        }

        /* PDF Preview Modal */
        .pdf-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .pdf-preview-content {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .pdf-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
        }

        .pdf-preview-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .pdf-preview-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .pdf-preview-close:hover {
            color: var(--danger);
        }

        .pdf-preview-options {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        .pdf-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .pdf-preview-table th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }

        .pdf-preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.75rem;
        }

        .pdf-spec-card {
            display: flex;
            gap: 2rem;
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            min-height: 200px;
        }

        .pdf-spec-content {
            flex: 1;
        }

        .pdf-spec-image {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .pdf-spec-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pdf-spec-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--accent);
        }

        .pdf-spec-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .pdf-spec-family {
            color: var(--accent);
            font-size: 0.875rem;
        }

        /* Cocktail Detail Page - Full Recipe with Batch Scaling */
        .cocktail-detail-page {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }

        .cocktail-silhouette {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
        }

        .cocktail-silhouette img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: left;
        }

        .detail-content {
            position: relative;
            z-index: 2;
        }

        .detail-header {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .detail-image {
            width: 120px;
            height: 120px;
            border-radius: 16px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .detail-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-upload-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 3;
        }

        .detail-title {
            flex: 1;
        }

        .detail-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .detail-venue {
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            margin: 1rem 0;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-item-label {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-item-value {
            font-size: 0.95rem;
            color: var(--dark);
            font-weight: 500;
        }

        .selling-price {
            background: var(--accent);
            color: white !important;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-weight: 700;
        }

        .recipe-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--accent);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recipe-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .recipe-table th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
        }

        .recipe-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .omit-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .scale-section {
            background: var(--white);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .scale-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scale-step {
            background: var(--light);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .scale-options {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .scale-option {
            flex: 1;
            min-width: 200px;
            background: var(--white);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scale-option:hover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .scale-option.active {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .scale-option-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .scale-option-desc {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .quantity-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .quantity-input {
            width: 120px;
            padding: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            font-size: 1rem;
        }

        .quantity-label {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .dilution-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .dilution-card {
            background: var(--white);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dilution-card:hover {
            border-color: var(--accent);
        }

        .dilution-card.active {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .dilution-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .dilution-desc {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .custom-dilution-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .calculate-btn {
            background: var(--accent);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
            margin-top: 1.5rem;
        }

        .calculate-btn:hover {
            background: var(--accent-light);
            transform: scale(1.01);
        }

        .scaled-results {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--accent);
        }

        .water-note {
            background: rgba(52, 152, 219, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #2980b9;
        }

        .serving-note {
            background: rgba(39, 174, 96, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 600;
        }

        .method-section {
            background: rgba(44,62,80,0.02);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .notes-section {
            background: var(--accent-soft);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: scale(1.02);
        }

        .btn-pdf {
            background: #E74C3C;
            color: var(--white);
        }

        .btn-pdf:hover {
            background: #c0392b;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent-soft);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        /* Wide form inputs */
        .wide-textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 120px;
            font-family: 'Inter', sans-serif;
        }

        .wide-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .family-datalist {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .family-datalist:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            font-size: 0.95rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-input[readonly] {
            background: var(--light);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--dark);
            color: var(--white);
            padding: 1rem 2rem;
            border-radius: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 1001;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
                padding-top: 5rem;
            }

            .cocktail-silhouette {
                width: 150px;
            }

            .scale-options {
                flex-direction: column;
            }

            .alphabet-nav-container {
                flex-direction: column;
            }

            .alphabet-nav {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                flex-direction: row;
                flex-wrap: wrap;
                max-width: 300px;
                background: var(--white);
                padding: 0.75rem;
                border-radius: 30px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            .spirit-filters {
                flex-direction: column;
            }

            .filter-input {
                width: 100%;
            }

            .theme-toggle {
                margin-left: 0;
                margin-top: 1rem;
                width: 100%;
                justify-content: center;
            }

            .overview-actions {
                flex-direction: column;
                width: 100%;
            }

            .overview-table {
                display: block;
                overflow-x: auto;
            }

            .pdf-spec-card {
                flex-direction: column;
            }

            .pdf-spec-image {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body class="theme-orange" id="appBody">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>üêë</span>
                    <span>BLACK SHEEP</span>
                </div>
                <div class="restaurant-badge">
                    <i class="fas fa-star"></i> Black Sheep Restaurants
                </div>
            </div>

            <nav class="nav-links">
                <div class="nav-item" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="drinks">
                    <i class="fas fa-cocktail"></i>
                    <span>Drinks Library</span>
                </div>
                <div class="nav-item" data-page="classic">
                    <i class="fas fa-book"></i>
                    <span>Classic Cocktails</span>
                </div>
                <div class="nav-item" data-page="spirit-library">
                    <i class="fas fa-wine-bottle"></i>
                    <span>Spirit Library</span>
                </div>
                <div class="nav-item" data-page="infusion">
                    <i class="fas fa-flask"></i>
                    <span>Infusion</span>
                </div>
                <div class="nav-item" data-page="distillation">
                    <i class="fas fa-wine-bottle"></i>
                    <span>Distillation</span>
                </div>
            </nav>

            <div class="favorites-section">
                <div class="favorites-title">
                    <i class="fas fa-star"></i>
                    <span>Favorite Cocktails</span>
                </div>
                <div id="favoritesList" class="favorites-list"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper" id="mainContent"></div>
        </main>
    </div>

    <!-- Spirit Edit Modal -->
    <div id="spiritEditModal" class="spirit-edit-modal">
        <div class="spirit-edit-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--accent);">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                    <i class="fas fa-edit"></i> Edit Spirit
                </h2>
                <button onclick="closeSpiritEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editSpiritForm" onsubmit="saveSpiritChanges(event)">
                <input type="hidden" id="editSpiritId">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Category</label>
                        <input type="text" id="editSpiritType" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Product</label>
                        <input type="text" id="editSpiritName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Size (ml)</label>
                        <input type="number" id="editSpiritBottleSize" class="form-input" step="0.1" min="0" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Cost ($)</label>
                        <input type="number" id="editSpiritBottleCost" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">ABV (%)</label>
                        <input type="number" id="editSpiritABV" class="form-input" step="0.1" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Supplier</label>
                        <input type="text" id="editSpiritSupplier" class="form-input">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeSpiritEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="pdf-preview-modal">
        <div class="pdf-preview-content">
            <div class="pdf-preview-header">
                <h2 class="pdf-preview-title" id="pdfPreviewTitle">PDF Preview</h2>
                <button class="pdf-preview-close" onclick="closePDFPreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="pdfPreviewContent" style="max-height: 60vh; overflow-y: auto;"></div>
            <div class="pdf-preview-options">
                <button class="btn btn-outline" onclick="closePDFPreview()">Cancel</button>
                <button class="btn btn-pdf" id="pdfDownloadBtn" onclick="downloadPDFFromPreview()">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn btn-share" id="pdfShareBtn" onclick="sharePDFFromPreview()">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Venue Modal -->
    <div id="editVenueModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 500px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-edit"></i> Edit Venue</h2>
                <button class="modal-close" onclick="closeModal('editVenueModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editVenueForm" onsubmit="saveVenueChanges(event)">
                <input type="hidden" id="editVenueId">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Venue Name</label>
                    <input type="text" id="editVenueName" class="form-input" required>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Location</label>
                    <input type="text" id="editVenueLocation" class="form-input" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Cocktail Modal -->
    <div id="addCocktailModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--accent);">
                <h2 class="modal-title" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                    <i class="fas fa-plus-circle"></i> Add New Cocktail
                </h2>
                <button class="modal-close" onclick="closeModal('addCocktailModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="newCocktailForm" onsubmit="saveNewCocktail(event)">
                <div id="venueSelectionField" style="margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Venue</label>
                        <select id="cocktailVenue" class="form-input" required>
                            <option value="">Select Venue...</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Name</label>
                        <input type="text" id="cocktailName" class="form-input" placeholder="e.g., La Rochelle Martini" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Cocktail Family</label>
                        <input list="cocktailFamilies" id="cocktailFamily" class="family-datalist" placeholder="Select or type family" required>
                        <datalist id="cocktailFamilies">
                            <option value="Signature"><option value="Classic"><option value="Sour"><option value="Collins">
                            <option value="Gimlet"><option value="Rickey"><option value="Sidecar"><option value="Smash">
                            <option value="Manhattan"><option value="Martini"><option value="Old Fashioned"><option value="Tiki"><option value="NA">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Cost Price ($)</label>
                        <input type="number" id="cocktailCostPrice" class="form-input" step="0.01" min="0" readonly style="background: var(--light);" value="0.00">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Selling Price ($)</label>
                        <input type="number" id="cocktailSellingPrice" class="form-input" step="0.01" min="0" placeholder="88.00" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Glassware</label>
                        <input type="text" id="cocktailGlass" class="form-input" placeholder="e.g., Coupe" required>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; color: var(--primary);">Garnish</label>
                        <input type="text" id="cocktailGarnish" class="form-input" placeholder="e.g., Lemon Zest" required>
                    </div>
                </div>
                <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-flask"></i> Recipe Ingredients
                </h3>
                <table class="ingredient-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 0.75rem; text-align: left;">Ingredient</th>
                            <th style="padding: 0.75rem; text-align: left;">Bottle (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Cost ($)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour</th>
                            <th style="padding: 0.75rem; text-align: left;">Unit</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour Cost</th>
                            <th style="padding: 0.75rem; text-align: left;">ABV %</th>
                            <th style="padding: 0.75rem; text-align: left;"></th>
                        </tr>
                    </thead>
                    <tbody id="ingredientTableBody">
                        <tr class="ingredient-row">
                            <td class="ingredient-search">
                                <input type="text" placeholder="Search or type ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                                <div class="autocomplete-list" id="autocomplete-0"></div>
                            </td>
                            <td><input type="number" placeholder="750" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                            <td>
                                <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                                    <option value="ml">ml</option>
                                    <option value="dash">dash</option>
                                </select>
                            </td>
                            <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                            <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                            <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline" onclick="addIngredientRow()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Add Ingredient
                </button>
                <div style="background: var(--accent-soft); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-tint" style="color: var(--accent);"></i>
                        <h3 style="color: var(--primary); font-size: 1.1rem; font-weight: 600;">Dilution</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionShake" value="shake" style="accent-color: var(--accent);">
                            <label for="dilutionShake">Shake <span style="color: var(--accent); font-weight: 700;">25%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionStir" value="stir" style="accent-color: var(--accent);">
                            <label for="dilutionStir">Stir <span style="color: var(--accent); font-weight: 700;">20%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionBuild" value="build" style="accent-color: var(--accent);">
                            <label for="dilutionBuild">Build <span style="color: var(--accent); font-weight: 700;">10%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionBlend" value="blend" style="accent-color: var(--accent);">
                            <label for="dilutionBlend">Blend <span style="color: var(--accent); font-weight: 700;">50%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionNone" value="none" checked style="accent-color: var(--accent);">
                            <label for="dilutionNone">No Dilution <span style="color: var(--accent); font-weight: 700;">0%</span></label>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="checkbox" id="useCustomDilution" onchange="toggleCustomDilution()" style="accent-color: var(--accent);">
                        <label for="useCustomDilution">Custom dilution</label>
                        <input type="number" id="customDilutionValue" class="form-input" placeholder="%" min="0" max="100" step="1" style="width: 80px; margin-left: 1rem; display: none;" disabled onchange="calculateFinalABV()">
                    </div>
                </div>
                <div id="finalAbvLiveDisplay" style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-percent"></i> Final ABV (after dilution)</span>
                    <span class="final-abv-value" id="finalAbvValue" style="font-size: 1.5rem; font-weight: 700;">0.0%</span>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: var(--primary);">Method</label>
                    <textarea id="cocktailMethod" class="wide-textarea" placeholder="e.g., Stir over ice, strain into chilled coupe..." rows="4" required></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: var(--primary);">Notes</label>
                    <textarea id="cocktailNotes" class="wide-textarea" placeholder="Additional notes, variations, tips..." rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addCocktailModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Cocktail</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Infusion Modal -->
    <div id="addInfusionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-flask"></i> New Infusion</h2>
                <button class="modal-close" onclick="closeModal('addInfusionModal')"><i class="fas fa-times"></i></button>
            </div>
            <form id="newInfusionForm" onsubmit="saveNewInfusion(event)">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="infusionName" class="form-input" placeholder="e.g., Spiced Pineapple Infusion" required>
                    </div>
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" id="infusionAuthor" class="form-input" placeholder="e.g., Bar Manager" value="Bar Manager">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" id="infusionDate" class="form-input" value="${new Date().toLocaleDateString()}" readonly style="background: var(--light);">
                    </div>
                </div>
                <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-flask"></i> Recipe Ingredients
                </h3>
                <table class="ingredient-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 0.75rem; text-align: left;">Ingredient</th>
                            <th style="padding: 0.75rem; text-align: left;">Bottle (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Cost ($)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour Cost</th>
                            <th style="padding: 0.75rem; text-align: left;">ABV %</th>
                            <th style="padding: 0.75rem; text-align: left;"></th>
                        </tr>
                    </thead>
                    <tbody id="infusionIngredientTableBody">
                        <tr class="infusion-ingredient-row">
                            <td><input type="text" placeholder="Ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="500" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-pour-cost"></td>
                            <td><input type="number" placeholder="47" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionTotalABV(this)" required></td>
                            <td><button type="button" onclick="removeInfusionIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline" onclick="addInfusionIngredientRow()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Add Ingredient
                </button>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Total Pour (ml)</label>
                        <input type="number" id="infusionTotalPour" class="form-input" readonly style="background: var(--light);" value="0">
                    </div>
                    <div class="form-group">
                        <label>Total Pour Cost ($)</label>
                        <input type="number" id="infusionTotalPourCost" class="form-input" readonly style="background: var(--light);" value="0.00">
                    </div>
                </div>
                <div style="background: var(--accent-soft); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-info-circle"></i> Meta Data
                    </h3>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Instructions</label>
                        <textarea id="infusionInstructions" class="wide-textarea" placeholder="Detailed infusion instructions..." rows="3"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Allergens</label>
                        <input type="text" id="infusionAllergens" class="form-input" placeholder="e.g., Nuts, Dairy, Gluten...">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="infusionNotes" class="wide-textarea" placeholder="Additional notes..." rows="2"></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addInfusionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Infusion</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Distillation Modal -->
    <div id="addDistillationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-wine-bottle"></i> New Distillation</h2>
                <button class="modal-close" onclick="closeModal('addDistillationModal')"><i class="fas fa-times"></i></button>
            </div>
            <form id="newDistillationForm" onsubmit="saveNewDistillation(event)">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="distillationName" class="form-input" placeholder="e.g., House Gin" required>
                    </div>
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" id="distillationAuthor" class="form-input" placeholder="e.g., Head Distiller" value="Head Distiller">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" id="distillationDate" class="form-input" value="${new Date().toLocaleDateString()}" readonly style="background: var(--light);">
                    </div>
                </div>
                <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-flask"></i> Botanicals
                </h3>
                <table class="ingredient-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 0.75rem; text-align: left;">Botanical</th>
                            <th style="padding: 0.75rem; text-align: left;">Bottle (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Cost ($)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour Cost</th>
                            <th style="padding: 0.75rem; text-align: left;">ABV %</th>
                            <th style="padding: 0.75rem; text-align: left;"></th>
                        </tr>
                    </thead>
                    <tbody id="distillationIngredientTableBody">
                        <tr class="distillation-ingredient-row">
                            <td><input type="text" placeholder="Juniper" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="1000" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="30" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-pour-cost"></td>
                            <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationTotalABV(this)" required></td>
                            <td><button type="button" onclick="removeDistillationIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline" onclick="addDistillationIngredientRow()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Add Botanical
                </button>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Total Pour (ml)</label>
                        <input type="number" id="distillationTotalPour" class="form-input" readonly style="background: var(--light);" value="0">
                    </div>
                    <div class="form-group">
                        <label>Total Pour Cost ($)</label>
                        <input type="number" id="distillationTotalPourCost" class="form-input" readonly style="background: var(--light);" value="0.00">
                    </div>
                </div>
                <div style="background: var(--accent-soft); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-info-circle"></i> Meta Data
                    </h3>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Instructions</label>
                        <textarea id="distillationInstructions" class="wide-textarea" placeholder="Detailed distillation instructions..." rows="3"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Allergens</label>
                        <input type="text" id="distillationAllergens" class="form-input" placeholder="e.g., Nuts, Gluten...">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="distillationNotes" class="wide-textarea" placeholder="Additional notes..." rows="2"></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addDistillationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Distillation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <script>
        // ============================================
        // FIREBASE INITIALIZATION WITH SYNC FUNCTIONALITY
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyB_6vXqZqZqZqZqZqZqZqZqZqZqZqZqZqZq",
            authDomain: "black-sheep-restaurants.firebaseapp.com",
            projectId: "black-sheep-restaurants",
            storageBucket: "black-sheep-restaurants.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789jkl"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Enable offline persistence for offline access
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Persistence failed');
                } else if (err.code == 'unimplemented') {
                    console.log('Persistence not available');
                }
            });

        // Sync Status Management
        let syncStatus = 'synced'; // 'synced', 'syncing', 'offline'
        let syncTimeout;

        function updateSyncStatus(status) {
            syncStatus = status;
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.className = `sync-status ${status}`;
                if (status === 'synced') {
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Synced';
                } else if (status === 'syncing') {
                    statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...';
                } else if (status === 'offline') {
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Offline';
                }
            }
        }

        // Check online status
        window.addEventListener('online', () => {
            updateSyncStatus('syncing');
            setTimeout(() => {
                loadAllData();
                updateSyncStatus('synced');
            }, 1000);
        });

        window.addEventListener('offline', () => {
            updateSyncStatus('offline');
            showToast('üì¥ You are offline. Changes will sync when connection returns.');
        });

        // ============================================
        // DATA LOADING AND SAVING FUNCTIONS
        // ============================================
        async function loadAllData() {
            updateSyncStatus('syncing');
            try {
                // Load venues
                const venuesSnapshot = await db.collection('venues').get();
                if (!venuesSnapshot.empty) {
                    AppState.venues = venuesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }

                // Load classic cocktails
                const classicsSnapshot = await db.collection('classicCocktails').get();
                if (!classicsSnapshot.empty) {
                    AppState.classicCocktails = classicsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }

                // Load spirit library
                const spiritsSnapshot = await db.collection('spiritLibrary').get();
                if (!spiritsSnapshot.empty) {
                    AppState.spiritLibrary = spiritsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }

                // Load infusions
                const infusionsSnapshot = await db.collection('infusions').get();
                if (!infusionsSnapshot.empty) {
                    AppState.infusions = infusionsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }

                // Load distillations
                const distillationsSnapshot = await db.collection('distillations').get();
                if (!distillationsSnapshot.empty) {
                    AppState.distillations = distillationsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                }

                updateSyncStatus('synced');
                showToast('‚úÖ Data loaded from cloud');
                
                // Refresh current view
                refreshCurrentView();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('offline');
                showToast('‚ö†Ô∏è Using cached data');
            }
        }

        async function saveVenues() {
            try {
                const batch = db.batch();
                AppState.venues.forEach(venue => {
                    const venueRef = db.collection('venues').doc(venue.id.toString());
                    batch.set(venueRef, venue);
                });
                await batch.commit();
            } catch (error) {
                console.error('Error saving venues:', error);
                throw error;
            }
        }

        async function saveClassicCocktails() {
            try {
                const batch = db.batch();
                AppState.classicCocktails.forEach(cocktail => {
                    const cocktailRef = db.collection('classicCocktails').doc(cocktail.id.toString());
                    batch.set(cocktailRef, cocktail);
                });
                await batch.commit();
            } catch (error) {
                console.error('Error saving classic cocktails:', error);
                throw error;
            }
        }

        async function saveSpiritLibrary() {
            try {
                const batch = db.batch();
                AppState.spiritLibrary.forEach(spirit => {
                    const spiritRef = db.collection('spiritLibrary').doc(spirit.id);
                    batch.set(spiritRef, spirit);
                });
                await batch.commit();
            } catch (error) {
                console.error('Error saving spirit library:', error);
                throw error;
            }
        }

        async function saveInfusions() {
            try {
                const batch = db.batch();
                AppState.infusions.forEach(infusion => {
                    const infusionRef = db.collection('infusions').doc(infusion.id.toString());
                    batch.set(infusionRef, infusion);
                });
                await batch.commit();
            } catch (error) {
                console.error('Error saving infusions:', error);
                throw error;
            }
        }

        async function saveDistillations() {
            try {
                const batch = db.batch();
                AppState.distillations.forEach(distillation => {
                    const distillationRef = db.collection('distillations').doc(distillation.id.toString());
                    batch.set(distillationRef, distillation);
                });
                await batch.commit();
            } catch (error) {
                console.error('Error saving distillations:', error);
                throw error;
            }
        }

        // Universal save function for any data change
        async function saveAllData() {
            if (!navigator.onLine) {
                updateSyncStatus('offline');
                return;
            }

            updateSyncStatus('syncing');
            clearTimeout(syncTimeout);
            
            syncTimeout = setTimeout(async () => {
                try {
                    await Promise.all([
                        saveVenues(),
                        saveClassicCocktails(),
                        saveSpiritLibrary(),
                        saveInfusions(),
                        saveDistillations()
                    ]);
                    updateSyncStatus('synced');
                    showToast('‚úÖ All changes saved to cloud');
                } catch (error) {
                    console.error('Error saving data:', error);
                    updateSyncStatus('offline');
                    showToast('‚ùå Failed to save changes');
                }
            }, 1000); // Debounce saves
        }

        // ============================================
        // IMAGE UPLOAD FUNCTIONS
        // ============================================
        async function uploadImage(file, path) {
            if (!file) return null;
            
            try {
                const storageRef = storage.ref();
                const imageRef = storageRef.child(path);
                await imageRef.put(file);
                const url = await imageRef.getDownloadURL();
                return url;
            } catch (error) {
                console.error('Error uploading image:', error);
                showToast('‚ùå Failed to upload image');
                return null;
            }
        }

        // Override existing image upload functions
        const originalUploadVenueImage = uploadVenueImage;
        uploadVenueImage = async function(venueId, event) {
            const file = event.target.files[0];
            if (file) {
                const path = `venues/${venueId}_${Date.now()}.jpg`;
                const url = await uploadImage(file, path);
                if (url) {
                    const venue = AppState.venues.find(v => v.id === venueId);
                    if (venue) {
                        venue.image = url;
                        renderVenuesGrid();
                        await saveAllData();
                        showToast(`‚úÖ ${venue.name} image updated`);
                    }
                }
            }
        };

        const originalUploadCocktailImage = uploadCocktailImage;
        uploadCocktailImage = async function(venueId, cocktailId, event) {
            const file = event.target.files[0];
            if (file) {
                const path = `cocktails/${venueId}_${cocktailId}_${Date.now()}.jpg`;
                const url = await uploadImage(file, path);
                if (url) {
                    const venue = AppState.venues.find(v => v.id === venueId);
                    const cocktail = venue.cocktails.find(c => c.id === cocktailId);
                    if (cocktail) {
                        cocktail.image = url;
                        renderCocktailDetailPage(venueId, cocktailId);
                        await saveAllData();
                        showToast(`‚úÖ ${cocktail.name} image updated`);
                    }
                }
            }
        };

        const originalUploadClassicCocktailImage = uploadClassicCocktailImage;
        uploadClassicCocktailImage = async function(cocktailId, event) {
            const file = event.target.files[0];
            if (file) {
                const path = `classic/${cocktailId}_${Date.now()}.jpg`;
                const url = await uploadImage(file, path);
                if (url) {
                    const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
                    if (cocktail) {
                        cocktail.image = url;
                        if (AppState.currentView === 'classic-detail' && AppState.selectedClassicCocktail === cocktailId) {
                            renderClassicCocktailDetailPage(cocktailId);
                        } else {
                            renderClassicCocktails();
                        }
                        await saveAllData();
                        showToast(`‚úÖ ${cocktail.name} image updated`);
                    }
                }
            }
        };

        // ============================================
        // MODIFIED STATE MANAGEMENT WITH AUTO-SAVE
        // ============================================
        // Constants
        const DASH_TO_ML = 0.92;

        // Theme Management
        let currentTheme = 'orange';

        function toggleTheme(theme) {
            const body = document.getElementById('appBody');
            if (theme === 'orange') {
                body.classList.remove('theme-blue');
                body.classList.add('theme-orange');
                currentTheme = 'orange';
                document.getElementById('themeOrangeBtn')?.classList.add('active');
                document.getElementById('themeBlueBtn')?.classList.remove('active');
            } else {
                body.classList.remove('theme-orange');
                body.classList.add('theme-blue');
                currentTheme = 'blue';
                document.getElementById('themeBlueBtn')?.classList.add('active');
                document.getElementById('themeOrangeBtn')?.classList.remove('active');
            }
            showToast(`Theme switched to ${theme === 'orange' ? 'Orange' : 'Light Blue'}`);
        }

        // State Management
        const AppState = {
            venues: [
                {
                    id: 1,
                    name: "The Chinnery",
                    location: "Central",
                    image: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400",
                    order: 1,
                    cocktails: [
                        {
                            id: 101,
                            name: "Black Sheep Old Fashioned",
                            category: "signature",
                            family: "Old Fashioned",
                            favorite: true,
                            image: "https://images.unsplash.com/photo-1470337458703-46ad1756a187?w=400",
                            order: 1,
                            recipe: [
                                { ingredient: "House Bourbon", amount: 60, unit: "ml", bottleSize: 750, bottleCost: 45, pourCost: 3.60, abv: 45, spiritId: "spirit-001" },
                                { ingredient: "Demerara Syrup", amount: 10, unit: "ml", bottleSize: 1000, bottleCost: 25, pourCost: 0.25, abv: 0, spiritId: null },
                                { ingredient: "Angostura Bitters", amount: 3, unit: "dash", bottleSize: 200, bottleCost: 30, pourCost: 0.45, abv: 45, spiritId: null }
                            ],
                            pourCost: 4.30,
                            sellingPrice: 128,
                            cogs: 3.36,
                            finalAbv: 37.5,
                            method: "Stir all ingredients with ice for 30 seconds. Strain into rocks glass over large ice cube. Express orange peel and discard.",
                            garnish: "Orange twist",
                            glassware: "Rocks glass",
                            dateAdded: "2024-01-15",
                            author: "Bar Manager",
                            dilutionPreset: "stir",
                            notes: "Use large format ice cube. Express oil from orange peel over drink before discarding.",
                            batchSize: 1
                        }
                    ]
                },
                {
                    id: 2,
                    name: "La Vache",
                    location: "SoHo",
                    image: "https://images.unsplash.com/photo-1550966871-3ed9cd9edce3?w=400",
                    order: 2,
                    cocktails: []
                },
                {
                    id: 3,
                    name: "New Punjab Club",
                    location: "Central",
                    image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400",
                    order: 3,
                    cocktails: []
                }
            ],
            classicCocktails: [
                {
                    id: 1001,
                    name: "Aviation",
                    category: "classic",
                    family: "Sour",
                    image: "https://images.unsplash.com/photo-1551024701-1b5e0d7d5c9e?w=400",
                    recipe: [
                        { ingredient: "Gin", amount: 60, unit: "ml", bottleSize: 700, bottleCost: 32, pourCost: 2.74, abv: 47, spiritId: null },
                        { ingredient: "Lemon Juice", amount: 15, unit: "ml", bottleSize: 1000, bottleCost: 12, pourCost: 0.18, abv: 0, spiritId: null },
                        { ingredient: "Maraschino Liqueur", amount: 15, unit: "ml", bottleSize: 700, bottleCost: 35, pourCost: 0.75, abv: 32, spiritId: null },
                        { ingredient: "Cr√®me de Violette", amount: 5, unit: "ml", bottleSize: 500, bottleCost: 30, pourCost: 0.30, abv: 20, spiritId: null }
                    ],
                    pourCost: 3.97,
                    sellingPrice: 140,
                    cogs: 2.84,
                    finalAbv: 26.5,
                    method: "Shake with ice, strain into coupe. Garnish with cherry.",
                    garnish: "Cherry",
                    glassware: "Coupe",
                    dateAdded: "2024-01-15",
                    author: "Classic Recipe",
                    dilutionPreset: "shake",
                    notes: "This classic aviation recipe creates a beautifully balanced cocktail with floral notes from the cr√®me de violette.",
                    favorite: false
                },
                {
                    id: 1002,
                    name: "Boulevardier",
                    category: "classic",
                    family: "Martini",
                    image: "https://images.unsplash.com/photo-1575023782549-62ca0d244b39?w=400",
                    recipe: [
                        { ingredient: "Bourbon", amount: 45, unit: "ml", bottleSize: 750, bottleCost: 38, pourCost: 2.28, abv: 40, spiritId: null },
                        { ingredient: "Campari", amount: 30, unit: "ml", bottleSize: 1000, bottleCost: 38, pourCost: 1.14, abv: 24, spiritId: null },
                        { ingredient: "Sweet Vermouth", amount: 30, unit: "ml", bottleSize: 750, bottleCost: 28, pourCost: 1.12, abv: 16, spiritId: null }
                    ],
                    pourCost: 4.54,
                    sellingPrice: 135,
                    cogs: 3.36,
                    finalAbv: 28.5,
                    method: "Stir with ice, strain into rocks glass over ice. Garnish with orange peel.",
                    garnish: "Orange peel",
                    glassware: "Rocks glass",
                    dateAdded: "2024-01-20",
                    author: "Classic Recipe",
                    dilutionPreset: "stir",
                    notes: "The Boulevardier is a classic cocktail that predates the Negroni and uses bourbon instead of gin.",
                    favorite: false
                },
                {
                    id: 1003,
                    name: "Classic Martini",
                    category: "classic",
                    family: "Martini",
                    image: "https://images.unsplash.com/photo-1575023782549-62ca0d244b39?w=400",
                    recipe: [
                        { ingredient: "London Dry Gin", amount: 60, unit: "ml", bottleSize: 700, bottleCost: 32, pourCost: 2.74, abv: 47, spiritId: null },
                        { ingredient: "Dry Vermouth", amount: 10, unit: "ml", bottleSize: 750, bottleCost: 28, pourCost: 0.37, abv: 18, spiritId: null }
                    ],
                    pourCost: 3.11,
                    sellingPrice: 120,
                    cogs: 2.59,
                    finalAbv: 39.2,
                    method: "Stir with ice, strain into chilled coupe. Garnish with lemon twist or olive.",
                    garnish: "Lemon twist or olive",
                    glassware: "Coupe",
                    dateAdded: "2024-01-10",
                    author: "Classic Recipe",
                    dilutionPreset: "stir",
                    notes: "The perfect dry martini. Use a high-quality gin and adjust vermouth to taste.",
                    favorite: false
                }
            ],
            spiritLibrary: [
                { id: "spirit-001", name: "Wild Turkey 101", type: "Bourbon", abv: 50.5, bottleSize: 750, bottleCost: 45, supplier: "Wild Turkey", lastUpdated: "2024-01-15" },
                { id: "spirit-002", name: "Monkey Shoulder", type: "Blended Scotch", abv: 40, bottleSize: 750, bottleCost: 38, supplier: "William Grant & Sons", lastUpdated: "2024-01-15" },
                { id: "spirit-003", name: "Laphroaig 10", type: "Islay Scotch", abv: 46, bottleSize: 750, bottleCost: 65, supplier: "Beam Suntory", lastUpdated: "2024-01-15" },
                { id: "spirit-004", name: "Beefeater", type: "London Dry Gin", abv: 47, bottleSize: 700, bottleCost: 32, supplier: "Pernod Ricard", lastUpdated: "2024-01-15" },
                { id: "spirit-005", name: "Campari", type: "Bitter Liqueur", abv: 24, bottleSize: 1000, bottleCost: 38, supplier: "Campari Group", lastUpdated: "2024-01-15" },
                { id: "spirit-006", name: "Angostura Bitters", type: "Aromatic Bitters", abv: 44.7, bottleSize: 200, bottleCost: 30, supplier: "Angostura", lastUpdated: "2024-01-15" },
                { id: "spirit-007", name: "Simple Syrup", type: "Syrup", abv: 0, bottleSize: 1000, bottleCost: 12, supplier: "House Made", lastUpdated: "2024-01-15" },
                { id: "spirit-008", name: "Carpano Antica", type: "Sweet Vermouth", abv: 16.5, bottleSize: 750, bottleCost: 28, supplier: "Carpano", lastUpdated: "2024-01-15" }
            ],
            infusions: [],
            distillations: [],
            dilutionPresets: {
                "shake": 0.25,
                "stir": 0.20,
                "build": 0.10,
                "blend": 0.50,
                "none": 0,
                "spirit-driven": 0.18
            },
            currentPage: 'dashboard',
            currentView: 'venues',
            selectedVenue: null,
            selectedCocktail: null,
            selectedClassicCocktail: null,
            selectedInfusion: null,
            selectedDistillation: null,
            scaleMethod: 'serving',
            scaleQuantity: 1,
            dilutionType: 'none',
            customDilution: 0.20,
            includeWater: true,
            showScaledResults: false,
            omittedIngredients: [],
            selectedCocktailsForPrint: [],
            nextCocktailId: 303,
            nextClassicCocktailId: 1004,
            nextVenueId: 4,
            nextInfusionId: 1,
            nextDistillationId: 1,
            searchResults: [],
            classicSearchTerm: '',
            infusionSearchTerm: '',
            distillationSearchTerm: '',
            pdfPreviewData: null,
            pdfPreviewType: null
        };

        // DOM Elements
        const mainContent = document.getElementById('mainContent');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');

        // Add sync status to top header
        function addSyncStatusToHeader() {
            const topHeader = document.querySelector('.top-header');
            if (topHeader && !document.getElementById('syncStatus')) {
                const syncDiv = document.createElement('div');
                syncDiv.id = 'syncStatus';
                syncDiv.className = 'sync-status synced';
                syncDiv.innerHTML = '<i class="fas fa-check-circle"></i> Synced';
                topHeader.appendChild(syncDiv);
            }
        }

        // Refresh current view after data load
        function refreshCurrentView() {
            if (AppState.currentPage === 'dashboard') {
                renderDashboard();
            } else if (AppState.currentPage === 'drinks') {
                if (AppState.currentView === 'venues') {
                    renderVenuesGrid();
                } else if (AppState.currentView === 'cocktails' && AppState.selectedVenue) {
                    selectVenue(AppState.selectedVenue);
                } else if (AppState.currentView === 'detail' && AppState.selectedVenue && AppState.selectedCocktail) {
                    renderCocktailDetailPage(AppState.selectedVenue, AppState.selectedCocktail);
                }
            } else if (AppState.currentPage === 'classic') {
                if (AppState.currentView === 'classic-detail' && AppState.selectedClassicCocktail) {
                    renderClassicCocktailDetailPage(AppState.selectedClassicCocktail);
                } else {
                    renderClassicCocktails();
                }
            } else if (AppState.currentPage === 'spirit-library') {
                renderSpiritLibrary();
            } else if (AppState.currentPage === 'infusion') {
                renderInfusionList();
            } else if (AppState.currentPage === 'distillation') {
                renderDistillationList();
            }
        }

        // Mobile Menu Toggle
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                const page = item.dataset.page;
                AppState.currentPage = page;
                
                if (page === 'drinks') {
                    AppState.currentView = 'venues';
                    AppState.selectedVenue = null;
                    AppState.selectedCocktail = null;
                    renderVenuesGrid();
                } else if (page === 'dashboard') {
                    renderDashboard();
                } else if (page === 'classic') {
                    renderClassicCocktails();
                } else if (page === 'spirit-library') {
                    renderSpiritLibrary();
                } else if (page === 'infusion') {
                    renderInfusionList();
                } else if (page === 'distillation') {
                    renderDistillationList();
                }
                
                if (window.innerWidth <= 768) sidebar.classList.remove('active');
            });
        });

        // Populate venue dropdown
        function populateVenueDropdown() {
            const select = document.getElementById('cocktailVenue');
            if (select) {
                select.innerHTML = '<option value="">Select Venue...</option>';
                AppState.venues.forEach(venue => {
                    select.innerHTML += `<option value="${venue.id}">${venue.name}</option>`;
                });
            }
        }

        // Convert unit
        function convertUnit(select) {
            const row = select.closest('tr');
            const pourInput = row.cells[3].querySelector('input');
            const unit = select.value;
            
            if (unit === 'dash') {
                const mlValue = parseFloat(pourInput.value) || 0;
                const dashValue = mlValue / DASH_TO_ML;
                pourInput.value = dashValue.toFixed(1);
            } else {
                const dashValue = parseFloat(pourInput.value) || 0;
                const mlValue = dashValue * DASH_TO_ML;
                pourInput.value = mlValue.toFixed(1);
            }
            
            calculateIngredientCost(pourInput);
        }

        // Dashboard
        function renderDashboard() {
            const totalCocktails = AppState.venues.reduce((acc, venue) => acc + venue.cocktails.length, 0) + AppState.classicCocktails.length;
            const totalSpirits = AppState.spiritLibrary.length;
            const totalInfusions = AppState.infusions.length;
            const totalDistillations = AppState.distillations.length;
            const favorites = AppState.venues.flatMap(v => v.cocktails.filter(c => c.favorite));
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <h1 class="page-title">
                            <i class="fas fa-home"></i> Dashboard
                        </h1>
                        <div class="theme-toggle">
                            <button id="themeOrangeBtn" class="theme-toggle-btn active" onclick="toggleTheme('orange')">
                                <i class="fas fa-sun"></i> Orange
                            </button>
                            <button id="themeBlueBtn" class="theme-toggle-btn" onclick="toggleTheme('blue')">
                                <i class="fas fa-water"></i> Light Blue
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Quick search..." id="globalSearch" onkeyup="handleGlobalSearch()" autocomplete="off">
                            <div id="globalSearchResults" class="search-results"></div>
                        </div>
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: var(--white); border-radius: 20px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-cocktail" style="color: var(--accent);"></i> Total Cocktails
                            </div>
                        </div>
                        <h2 style="font-size: 3rem; color: var(--accent);">${totalCocktails}</h2>
                        <p style="color: var(--gray);">Across ${AppState.venues.length} venues + Classics</p>
                    </div>
                    <div style="background: var(--white); border-radius: 20px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-wine-bottle" style="color: var(--accent);"></i> Spirit Library
                            </div>
                        </div>
                        <h2 style="font-size: 3rem; color: var(--accent);">${totalSpirits}</h2>
                        <p style="color: var(--gray);">Active spirits</p>
                    </div>
                    <div style="background: var(--white); border-radius: 20px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-star" style="color: var(--accent);"></i> Favorites
                            </div>
                        </div>
                        <h2 style="font-size: 3rem; color: var(--accent);">${favorites.length}</h2>
                        <p style="color: var(--gray);">Starred cocktails</p>
                    </div>
                </div>
            `;

            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('.search-container');
                if (searchContainer && !searchContainer.contains(e.target)) {
                    const results = document.getElementById('globalSearchResults');
                    if (results) results.style.display = 'none';
                }
            });
        }

        // Global Search
        function handleGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const resultsContainer = document.getElementById('globalSearchResults');
            
            if (searchTerm.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }

            const results = [];

            AppState.venues.forEach(venue => {
                venue.cocktails.forEach(cocktail => {
                    if (cocktail.name.toLowerCase().includes(searchTerm)) {
                        results.push({
                            type: 'Cocktail',
                            name: cocktail.name,
                            venue: venue.name,
                            action: () => viewCocktailDetail(venue.id, cocktail.id)
                        });
                    }
                });
            });

            AppState.classicCocktails.forEach(cocktail => {
                if (cocktail.name.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Classic Cocktail',
                        name: cocktail.name,
                        action: () => viewClassicCocktailDetail(cocktail.id)
                    });
                }
            });

            AppState.spiritLibrary.forEach(spirit => {
                if (spirit.name.toLowerCase().includes(searchTerm) || spirit.type.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Spirit',
                        name: spirit.name,
                        brand: spirit.type,
                        action: () => {
                            AppState.currentPage = 'spirit-library';
                            renderSpiritLibrary();
                        }
                    });
                }
            });

            AppState.infusions.forEach(infusion => {
                if (infusion.name.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Infusion',
                        name: infusion.name,
                        action: () => viewInfusionDetail(infusion.id)
                    });
                }
            });

            AppState.distillations.forEach(distillation => {
                if (distillation.name.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Distillation',
                        name: distillation.name,
                        action: () => viewDistillationDetail(distillation.id)
                    });
                }
            });

            AppState.searchResults = results;
            resultsContainer.innerHTML = results.slice(0, 10).map(result => `
                <div class="search-result-item" onclick="executeSearchResult(this, '${result.type}', '${result.name}')">
                    <div class="search-result-category">${result.type}</div>
                    <div style="font-weight: 600;">${result.name}</div>
                    <div style="font-size: 0.75rem; color: var(--gray);">${result.venue || result.brand || ''}</div>
                </div>
            `).join('');
            
            resultsContainer.style.display = results.length ? 'block' : 'none';
        }

        function executeSearchResult(element, type, name) {
            const result = AppState.searchResults.find(r => r.type === type && r.name === name);
            if (result?.action) result.action();
            document.getElementById('globalSearchResults').style.display = 'none';
            document.getElementById('globalSearch').value = '';
        }

        // VENUES - Menu Overview Button with Selection
        function renderVenuesGrid() {
            const sortedVenues = [...AppState.venues].sort((a, b) => a.order - b.order);
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-store"></i> Venues
                    </h1>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="openAddVenueModal()">
                            <i class="fas fa-plus"></i> New Venue
                        </button>
                    </div>
                </div>

                <div class="venue-grid" id="venueGrid">
                    ${sortedVenues.map(venue => `
                        <div class="venue-card" data-id="${venue.id}" data-order="${venue.order}">
                            <div class="venue-drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="venue-image">
                                <img src="${venue.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400'}" alt="${venue.name}">
                                <div class="venue-image-upload" onclick="event.stopPropagation(); document.getElementById('venueImageUpload_${venue.id}').click()">
                                    <i class="fas fa-camera"></i> Change
                                    <input type="file" id="venueImageUpload_${venue.id}" accept="image/*" style="display: none;" onchange="uploadVenueImage(${venue.id}, event)">
                                </div>
                            </div>
                            <div class="venue-info">
                                <div class="venue-name-large">${venue.name}</div>
                                <div class="venue-location"><i class="fas fa-location-dot"></i> ${venue.location}</div>
                                <div class="venue-stats">
                                    <div class="venue-stat" onclick="selectVenue(${venue.id})">
                                        <i class="fas fa-cocktail"></i> ${venue.cocktails.length} Cocktails
                                    </div>
                                </div>
                                <div class="venue-actions">
                                    <button class="venue-action-btn venue-edit-btn" onclick="event.stopPropagation(); editVenue(${venue.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="venue-action-btn venue-overview-btn" onclick="event.stopPropagation(); viewCocktailOverview(${venue.id})">
                                        <i class="fas fa-list"></i> Menu
                                    </button>
                                    <button class="venue-action-btn venue-delete-btn" onclick="event.stopPropagation(); deleteVenue(${venue.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            setTimeout(() => {
                const venueGrid = document.getElementById('venueGrid');
                if (venueGrid) {
                    new Sortable(venueGrid, {
                        animation: 150,
                        handle: '.venue-drag-handle',
                        onEnd: () => {
                            const cards = document.querySelectorAll('.venue-card');
                            cards.forEach((card, i) => {
                                const venue = AppState.venues.find(v => v.id === parseInt(card.dataset.id));
                                if (venue) venue.order = i + 1;
                            });
                            AppState.venues.sort((a, b) => a.order - b.order);
                            saveAllData();
                            showToast('Venue order updated');
                        }
                    });
                }
            }, 100);
        }

        // View Cocktail Overview (Menu) - With Selection and Select All
        function viewCocktailOverview(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            if (!venue) {
                showToast('‚ùå Venue not found');
                return;
            }
            
            AppState.currentView = 'overview';
            AppState.selectedVenue = venueId;
            AppState.selectedCocktailsForPrint = [];
            
            const sortedCocktails = [...venue.cocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <button class="back-button" onclick="renderVenuesGrid()">
                            <i class="fas fa-arrow-left"></i> Back to Venues
                        </button>
                        <h1 class="page-title" style="margin-left: 1rem;">
                            <i class="fas fa-cocktail"></i> ${venue.name} - Cocktail Menu
                        </h1>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <div class="overview-actions">
                            <div class="selection-actions">
                                <button class="btn btn-outline btn-sm" onclick="selectAllCocktails(${venueId})">
                                    <i class="fas fa-check-double"></i> Select All
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="clearCocktailSelection(${venueId})">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                            <button class="btn btn-outline" onclick="previewMenuPDF(${venueId})">
                                <i class="fas fa-eye"></i> Preview Menu
                            </button>
                            <button class="btn btn-outline" onclick="previewSpecsPDF(${venueId})">
                                <i class="fas fa-file-pdf"></i> Preview Specs
                            </button>
                            <button class="btn btn-pdf" onclick="printSelectedSpecsPDF(${venueId})">
                                <i class="fas fa-print"></i> Print Selected
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overview-container">
                    <div class="overview-header">
                        <div class="overview-title">
                            <i class="fas fa-list-ul"></i> Cocktail Menu Overview
                        </div>
                        <span style="color: var(--gray);">Selected: <span id="selectedCount">0</span> cocktails</span>
                    </div>

                    <table class="overview-table" id="overviewTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="select-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(${venueId}, this.checked)">
                                </th>
                                <th>Cocktail Name</th>
                                <th>Family</th>
                                <th>Ingredients</th>
                                <th>Final ABV</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>COGS %</th>
                                <th>Glassware</th>
                                <th>Garnish</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedCocktails.map(cocktail => {
                                const cogsClass = cocktail.cogs < 20 ? 'cogs-good' : cocktail.cogs < 25 ? 'cogs-warning' : 'cogs-high';
                                const isSelected = AppState.selectedCocktailsForPrint.includes(cocktail.id);
                                return `
                                    <tr class="${isSelected ? 'selected' : ''}" data-cocktail-id="${cocktail.id}" onclick="toggleCocktailSelection(${venueId}, ${cocktail.id}, event)">
                                        <td onclick="event.stopPropagation();">
                                            <input type="checkbox" class="select-checkbox" data-cocktail-id="${cocktail.id}" 
                                                   ${isSelected ? 'checked' : ''} onchange="toggleCocktailSelection(${venueId}, ${cocktail.id}, event, true)">
                                        </td>
                                        <td style="font-weight: 600; color: var(--accent);">${cocktail.name}</td>
                                        <td>${cocktail.family || 'Signature'}</td>
                                        <td>${cocktail.recipe.map(r => `${r.amount}${r.unit} ${r.ingredient}`).join(', ')}</td>
                                        <td>${cocktail.finalAbv.toFixed(1)}%</td>
                                        <td>$${cocktail.pourCost.toFixed(2)}</td>
                                        <td>
                                            <span class="editable-price" onclick="event.stopPropagation(); editSellingPrice(${venueId}, ${cocktail.id}, this)">
                                                $${cocktail.sellingPrice}
                                            </span>
                                        </td>
                                        <td class="${cogsClass}">${cocktail.cogs}%</td>
                                        <td>${cocktail.glassware}</td>
                                        <td>${cocktail.garnish}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    ${!venue.cocktails.length ? `
                        <div style="text-align: center; padding: 3rem; color: var(--gray);">
                            <i class="fas fa-cocktail" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>No cocktails yet. Add your first cocktail!</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            updateSelectedCount();
        }

        // Edit Selling Price in Overview
        function editSellingPrice(venueId, cocktailId, element) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue?.cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            const currentPrice = cocktail.sellingPrice;
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentPrice;
            input.className = 'price-input';
            input.step = '0.01';
            input.min = '0';
            
            input.onclick = (e) => e.stopPropagation();
            
            input.onblur = async () => {
                const newPrice = parseFloat(input.value);
                if (!isNaN(newPrice) && newPrice >= 0 && newPrice !== currentPrice) {
                    cocktail.sellingPrice = newPrice;
                    cocktail.cogs = ((cocktail.pourCost / newPrice) * 100).toFixed(1);
                    await saveAllData();
                    viewCocktailOverview(venueId);
                    showToast(`‚úÖ Updated ${cocktail.name} price to $${newPrice.toFixed(2)}`);
                } else {
                    element.innerHTML = `$${currentPrice}`;
                    element.style.display = 'inline';
                }
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            element.style.display = 'none';
            element.parentNode.insertBefore(input, element.nextSibling);
            input.focus();
            input.select();
        }

        // Selection Functions
        function toggleCocktailSelection(venueId, cocktailId, event, isCheckbox = false) {
            if (!isCheckbox) {
                const checkbox = event.currentTarget.querySelector(`input[data-cocktail-id="${cocktailId}"]`);
                if (checkbox) checkbox.checked = !checkbox.checked;
            }
            
            const index = AppState.selectedCocktailsForPrint.indexOf(cocktailId);
            if (index === -1) {
                AppState.selectedCocktailsForPrint.push(cocktailId);
                event.currentTarget.classList.add('selected');
            } else {
                AppState.selectedCocktailsForPrint.splice(index, 1);
                event.currentTarget.classList.remove('selected');
            }
            
            updateSelectedCount();
            updateSelectAllCheckbox();
        }

        function selectAllCocktails(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            AppState.selectedCocktailsForPrint = venue.cocktails.map(c => c.id);
            
            const checkboxes = document.querySelectorAll('.overview-table .select-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            
            const rows = document.querySelectorAll('.overview-table tbody tr');
            rows.forEach(row => row.classList.add('selected'));
            
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectedCount();
            showToast(`‚úÖ Selected ${AppState.selectedCocktailsForPrint.length} cocktails`);
        }

        function clearCocktailSelection(venueId) {
            AppState.selectedCocktailsForPrint = [];
            
            const checkboxes = document.querySelectorAll('.overview-table .select-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            
            const rows = document.querySelectorAll('.overview-table tbody tr');
            rows.forEach(row => row.classList.remove('selected'));
            
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedCount();
            showToast('Selection cleared');
        }

        function toggleSelectAll(venueId, checked) {
            if (checked) {
                selectAllCocktails(venueId);
            } else {
                clearCocktailSelection(venueId);
            }
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            if (countEl) {
                countEl.textContent = AppState.selectedCocktailsForPrint.length;
            }
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                const venue = AppState.venues.find(v => v.id === AppState.selectedVenue);
                if (venue) {
                    selectAll.checked = AppState.selectedCocktailsForPrint.length === venue.cocktails.length && venue.cocktails.length > 0;
                }
            }
        }

        // PDF Preview Functions - Updated Specs without pricing, with images
        function previewMenuPDF(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            if (!venue) return;
            
            const sortedCocktails = [...venue.cocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            let previewHTML = `
                <div style="padding: 1rem;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="width: 40px; height: 40px; background: var(--sheep-black); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-sheep"></i>
                            </div>
                            <h1 style="color: var(--primary); font-size: 1.75rem;">üêë BLACK SHEEP</h1>
                        </div>
                        <p style="color: var(--accent); font-weight: 600;">${venue.name} - Cocktail Menu</p>
                        <p style="color: var(--gray); font-size: 0.875rem;">Generated: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <table class="pdf-preview-table">
                        <thead>
                            <tr>
                                <th>Cocktail Name</th>
                                <th>Family</th>
                                <th>Final ABV</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>COGS %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedCocktails.map(cocktail => `
                                <tr>
                                    <td style="font-weight: 600;">${cocktail.name}</td>
                                    <td>${cocktail.family || 'Signature'}</td>
                                    <td>${cocktail.finalAbv.toFixed(1)}%</td>
                                    <td>$${cocktail.pourCost.toFixed(2)}</td>
                                    <td>$${cocktail.sellingPrice}</td>
                                    <td style="color: ${cocktail.cogs < 20 ? 'var(--success)' : cocktail.cogs < 25 ? '#F39C12' : 'var(--danger)'}; font-weight: 600;">
                                        ${cocktail.cogs}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05); text-align: center; color: var(--gray); font-size: 0.75rem;">
                        <p>Black Sheep Restaurants ‚Ä¢ Confidential</p>
                    </div>
                </div>
            `;
            
            AppState.pdfPreviewData = { venue, cocktails: sortedCocktails, type: 'menu' };
            AppState.pdfPreviewType = 'menu';
            
            document.getElementById('pdfPreviewTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Menu Overview Preview';
            document.getElementById('pdfPreviewContent').innerHTML = previewHTML;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
        }

        function previewSpecsPDF(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            if (!venue) return;
            
            const cocktails = AppState.selectedCocktailsForPrint.length > 0 
                ? venue.cocktails.filter(c => AppState.selectedCocktailsForPrint.includes(c.id))
                : venue.cocktails;
            
            if (cocktails.length === 0) {
                showToast('‚ö†Ô∏è Please select at least one cocktail');
                return;
            }
            
            const sortedCocktails = [...cocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            let previewHTML = `
                <div style="padding: 1rem;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="width: 40px; height: 40px; background: var(--sheep-black); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-sheep"></i>
                            </div>
                            <h1 style="color: var(--primary); font-size: 1.75rem;">üêë BLACK SHEEP</h1>
                        </div>
                        <p style="color: var(--accent); font-weight: 600;">${venue.name} - Cocktail Specs</p>
                        <p style="color: var(--gray); font-size: 0.875rem;">Generated: ${new Date().toLocaleDateString()}</p>
                    </div>
            `;
            
            sortedCocktails.forEach(cocktail => {
                previewHTML += `
                    <div class="pdf-spec-card">
                        <div class="pdf-spec-content">
                            <div class="pdf-spec-header">
                                <div>
                                    <div class="pdf-spec-name">${cocktail.name}</div>
                                    <div class="pdf-spec-family">${venue.name} ‚Ä¢ ${cocktail.family || 'Signature'}</div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">RECIPE</div>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${cocktail.recipe.map(item => `<li style="padding: 0.25rem 0; font-size: 0.875rem; color: var(--dark);">‚Ä¢ ${item.amount}${item.unit} ${item.ingredient}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div><span style="font-weight: 600;">Glassware:</span> ${cocktail.glassware}</div>
                                <div><span style="font-weight: 600;">Garnish:</span> ${cocktail.garnish}</div>
                                <div><span style="font-weight: 600;">ABV:</span> ${cocktail.finalAbv.toFixed(1)}%</div>
                            </div>
                            
                            <div>
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.25rem;">METHOD</div>
                                <p style="color: var(--dark); font-size: 0.875rem; line-height: 1.5;">${cocktail.method}</p>
                            </div>
                        </div>
                        <div class="pdf-spec-image">
                            <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="${cocktail.name}">
                        </div>
                    </div>
                `;
            });
            
            previewHTML += `</div>`;
            
            AppState.pdfPreviewData = { venue, cocktails: sortedCocktails, type: 'specs' };
            AppState.pdfPreviewType = 'specs';
            
            document.getElementById('pdfPreviewTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Cocktail Specs Preview';
            document.getElementById('pdfPreviewContent').innerHTML = previewHTML;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
        }

        function printSelectedSpecsPDF(venueId) {
            if (AppState.selectedCocktailsForPrint.length === 0) {
                showToast('‚ö†Ô∏è Please select at least one cocktail');
                return;
            }
            previewSpecsPDF(venueId);
        }

        function closePDFPreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
            AppState.pdfPreviewData = null;
            AppState.pdfPreviewType = null;
        }

        async function downloadPDFFromPreview() {
            if (!AppState.pdfPreviewData) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            if (AppState.pdfPreviewType === 'menu') {
                await generateMenuPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            } else {
                await generateSpecsPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            }
            
            closePDFPreview();
        }

        async function sharePDFFromPreview() {
            if (!AppState.pdfPreviewData) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            if (AppState.pdfPreviewType === 'menu') {
                await generateMenuPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            } else {
                await generateSpecsPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            }
            
            const pdfBlob = pdf.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `${AppState.pdfPreviewData.venue.name} - Cocktail ${AppState.pdfPreviewType === 'menu' ? 'Menu' : 'Specs'}`,
                        files: [new File([pdfBlob], `${AppState.pdfPreviewData.venue.name}_${AppState.pdfPreviewType}.pdf`, { type: 'application/pdf' })]
                    });
                    showToast('‚úÖ PDF shared successfully');
                } catch (error) {
                    window.open(pdfUrl, '_blank');
                }
            } else {
                window.open(pdfUrl, '_blank');
            }
            
            closePDFPreview();
        }

        async function generateMenuPDF(pdf, venue, cocktails) {
            let yOffset = 20;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 20;

            pdf.setFillColor(26, 26, 26);
            pdf.circle(30, yOffset, 8, 'F');
            pdf.setTextColor(230, 126, 34);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text('üêë BLACK SHEEP', 45, yOffset + 5);
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(16);
            pdf.text(venue.name, 45, yOffset + 15);
            
            yOffset += 25;
            pdf.setDrawColor(230, 126, 34);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
            yOffset += 15;

            pdf.setFillColor(236, 240, 241);
            pdf.rect(margin, yOffset - 4, pdf.internal.pageSize.width - 40, 10, 'F');
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Cocktail Name', margin + 2, yOffset);
            pdf.text('Family', margin + 60, yOffset);
            pdf.text('ABV', margin + 100, yOffset);
            pdf.text('Cost', margin + 130, yOffset);
            pdf.text('Selling', margin + 155, yOffset);
            pdf.text('COGS', margin + 180, yOffset);
            
            yOffset += 10;

            cocktails.forEach((cocktail) => {
                if (yOffset > pageHeight - 20) {
                    pdf.addPage();
                    yOffset = 20;
                }

                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(cocktail.name.substring(0, 20), margin + 2, yOffset);
                pdf.text(cocktail.family || 'Signature', margin + 60, yOffset);
                pdf.text(`${cocktail.finalAbv.toFixed(1)}%`, margin + 100, yOffset);
                pdf.text(`$${cocktail.pourCost.toFixed(2)}`, margin + 130, yOffset);
                pdf.text(`$${cocktail.sellingPrice}`, margin + 155, yOffset);
                
                pdf.setTextColor(cocktail.cogs < 20 ? 39 : cocktail.cogs < 25 ? 243 : 231, 
                               cocktail.cogs < 20 ? 174 : cocktail.cogs < 25 ? 156 : 76, 
                               cocktail.cogs < 20 ? 96 : cocktail.cogs < 25 ? 18 : 60);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`${cocktail.cogs}%`, margin + 180, yOffset);
                
                yOffset += 8;
            });

            pdf.save(`${venue.name}_Menu_Overview.pdf`);
            showToast(`‚úÖ Menu PDF generated`);
        }

        async function generateSpecsPDF(pdf, venue, cocktails) {
            let yOffset = 20;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 20;

            for (let i = 0; i < cocktails.length; i++) {
                const cocktail = cocktails[i];
                
                if (yOffset > pageHeight - 80) {
                    pdf.addPage();
                    yOffset = 20;
                }

                pdf.setFillColor(26, 26, 26);
                pdf.circle(30, yOffset, 8, 'F');
                pdf.setTextColor(230, 126, 34);
                pdf.setFontSize(24);
                pdf.setFont('helvetica', 'bold');
                pdf.text('üêë BLACK SHEEP', 45, yOffset + 5);
                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(16);
                pdf.text('COCKTAIL SPEC', 45, yOffset + 15);
                
                yOffset += 25;
                pdf.setDrawColor(230, 126, 34);
                pdf.setLineWidth(0.5);
                pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
                yOffset += 15;

                pdf.setTextColor(230, 126, 34);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(cocktail.name, margin, yOffset);
                
                yOffset += 8;
                pdf.setTextColor(149, 165, 166);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`${venue.name} ‚Ä¢ ${cocktail.family || 'Signature'}`, margin, yOffset);
                yOffset += 12;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RECIPE', margin, yOffset);
                yOffset += 6;
                
                cocktail.recipe.forEach((item) => {
                    pdf.setTextColor(52, 73, 94);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`‚Ä¢ ${item.amount}${item.unit} ${item.ingredient}`, margin + 5, yOffset);
                    yOffset += 5;
                });
                
                yOffset += 5;
                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GLASSWARE:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.glassware}`, margin + 35, yOffset);
                
                yOffset += 6;
                pdf.setTextColor(44, 62, 80);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GARNISH:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.garnish}`, margin + 35, yOffset);
                
                yOffset += 8;
                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('METHOD', margin, yOffset);
                
                yOffset += 6;
                const methodLines = pdf.splitTextToSize(cocktail.method, pdf.internal.pageSize.width - 40);
                pdf.setTextColor(52, 73, 94);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(methodLines, margin + 5, yOffset);
                
                yOffset += methodLines.length * 5 + 20;
                
                // Add image if space allows
                if (cocktail.image && yOffset < pageHeight - 60) {
                    try {
                        const img = new Image();
                        img.src = cocktail.image;
                        // This is simplified - in production you'd need to handle image loading
                        pdf.addImage(cocktail.image, 'JPEG', pdf.internal.pageSize.width - 50, yOffset - 40, 30, 30);
                    } catch (e) {
                        // Skip image if error
                    }
                }
                
                if (i < cocktails.length - 1) {
                    pdf.addPage();
                    yOffset = 20;
                }
            }

            pdf.save(`${venue.name}_Cocktail_Specs.pdf`);
            showToast(`‚úÖ Specs PDF generated for ${cocktails.length} cocktails`);
        }

        // Select Venue - Full Cocktail Detail with Batch Scaling and Dilution
        function selectVenue(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            if (!venue) return;
            
            AppState.currentView = 'cocktails';
            AppState.selectedVenue = venueId;
            AppState.selectedCocktail = null;
            
            const sortedCocktails = [...venue.cocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="back-button" onclick="renderVenuesGrid()">
                            <i class="fas fa-arrow-left"></i> Back to Venues
                        </button>
                        <h1 class="page-title" style="margin-left: 1rem;">
                            <i class="fas fa-cocktail"></i> ${venue.name}
                        </h1>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="openAddCocktailModalForVenue(${venue.id})">
                            <i class="fas fa-plus"></i> New Cocktail
                        </button>
                    </div>
                </div>

                <div class="item-list">
                    ${sortedCocktails.map(cocktail => `
                        <div class="item-card" onclick="viewCocktailDetail(${venue.id}, ${cocktail.id})">
                            <div class="item-thumbnail">
                                <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=100'}" alt="${cocktail.name}">
                            </div>
                            <div class="item-info">
                                <div class="item-name">
                                    ${cocktail.name}
                                    ${cocktail.favorite ? '<i class="fas fa-star favorite-star"></i>' : ''}
                                </div>
                                <div class="item-meta">
                                    <span><i class="fas fa-wine-glass"></i> ${cocktail.glassware}</span>
                                    <span><i class="fas fa-leaf"></i> ${cocktail.garnish}</span>
                                    <span><i class="fas fa-percent"></i> ${cocktail.finalAbv.toFixed(1)}% ABV</span>
                                    <span class="item-badge">$${cocktail.sellingPrice}</span>
                                    <button class="action-btn" onclick="event.stopPropagation(); editCocktail(${venue.id}, ${cocktail.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="action-btn share-btn" onclick="event.stopPropagation(); shareCocktail(${venue.id}, ${cocktail.id})">
                                        <i class="fas fa-share-alt"></i> Share
                                    </button>
                                    <button class="action-btn" onclick="event.stopPropagation(); toggleFavorite(${venue.id}, ${cocktail.id})" 
                                            style="border-color: var(--accent); color: var(--accent);">
                                        <i class="fa${cocktail.favorite ? 's' : 'r'} fa-star"></i>
                                    </button>
                                </div>
                                <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.875rem;">
                                    ${cocktail.recipe.length} ingredients ‚Ä¢ COGS: ${cocktail.cogs}%
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    ${!venue.cocktails.length ? `
                        <div style="background: var(--white); border-radius: 20px; padding: 3rem; text-align: center;">
                            <i class="fas fa-cocktail" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">No Cocktails Yet</h3>
                            <p style="color: var(--gray); margin-bottom: 1.5rem;">Add your first cocktail by clicking the button above.</p>
                            <button class="btn btn-primary" onclick="openAddCocktailModalForVenue(${venue.id})">
                                <i class="fas fa-plus"></i> Create Cocktail
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // View Cocktail Detail - Full Page with Batch Scaling and Dilution (for venue cocktails)
        function viewCocktailDetail(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue?.cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            AppState.currentView = 'detail';
            AppState.selectedVenue = venueId;
            AppState.selectedCocktail = cocktailId;
            AppState.scaleMethod = 'serving';
            AppState.scaleQuantity = 1;
            AppState.dilutionType = cocktail.dilutionPreset || 'none';
            AppState.customDilution = 0.20;
            AppState.showScaledResults = false;
            AppState.omittedIngredients = [];
            AppState.includeWater = true;
            
            renderCocktailDetailPage(venueId, cocktailId);
        }

        // View Classic Cocktail Detail - Full Page with Batch Scaling and Dilution
        function viewClassicCocktailDetail(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            AppState.currentView = 'classic-detail';
            AppState.selectedClassicCocktail = cocktailId;
            AppState.scaleMethod = 'serving';
            AppState.scaleQuantity = 1;
            AppState.dilutionType = cocktail.dilutionPreset || 'none';
            AppState.customDilution = 0.20;
            AppState.showScaledResults = false;
            AppState.omittedIngredients = [];
            AppState.includeWater = true;
            
            renderClassicCocktailDetailPage(cocktailId);
        }

        // Render Classic Cocktail Detail Page
        function renderClassicCocktailDetailPage(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;

            let dilutionFactor = AppState.dilutionPresets[AppState.dilutionType] || 0;
            if (AppState.dilutionType === 'custom') {
                dilutionFactor = AppState.customDilution;
            }

            const activeRecipe = cocktail.recipe.filter((item, index) => 
                !AppState.omittedIngredients.includes(`${cocktailId}-${index}`)
            );

            const totalPreDilutionVolume = activeRecipe.reduce((acc, item) => {
                if (item.unit === 'ml') return acc + item.amount;
                if (item.unit === 'dash') return acc + (item.amount * DASH_TO_ML);
                if (item.unit === 'oz') return acc + (item.amount * 29.5735);
                return acc;
            }, 0);

            const scaleFactor = AppState.scaleMethod === 'serving' 
                ? AppState.scaleQuantity / (cocktail.batchSize || 1)
                : AppState.scaleQuantity / totalPreDilutionVolume;
            
            const waterAmount = AppState.showScaledResults && dilutionFactor > 0 ? totalPreDilutionVolume * dilutionFactor * scaleFactor : 0;
            
            let scaledRecipe = [];
            let totalVolume = 0;
            let batchCost = 0;
            let batchRevenue = 0;
            let finalAbv = 0;
            let servingsFromVolume = 0;
            
            if (AppState.showScaledResults) {
                scaledRecipe = activeRecipe.map(item => ({
                    ...item,
                    scaledAmount: (item.amount * scaleFactor).toFixed(1)
                }));

                if (AppState.includeWater && waterAmount > 0) {
                    scaledRecipe.push({
                        ingredient: "Water (dilution)",
                        amount: 0,
                        scaledAmount: waterAmount.toFixed(1),
                        unit: "ml",
                        pourCost: 0,
                        abv: 0,
                        isWater: true
                    });
                }

                totalVolume = scaledRecipe.reduce((acc, item) => acc + parseFloat(item.scaledAmount), 0);
                batchCost = activeRecipe.reduce((acc, item) => acc + (item.pourCost * scaleFactor), 0);
                batchRevenue = (cocktail.sellingPrice * (AppState.scaleMethod === 'serving' ? AppState.scaleQuantity : totalVolume / 150));
                servingsFromVolume = Math.round(totalVolume / 150);
                
                const totalAlcohol = activeRecipe.reduce((acc, item) => {
                    let amount = item.amount;
                    if (item.unit === 'dash') {
                        amount = amount * DASH_TO_ML;
                    }
                    return acc + (amount * (item.abv / 100));
                }, 0);
                
                finalAbv = totalPreDilutionVolume > 0 
                    ? (totalAlcohol / totalPreDilutionVolume) / (1 + dilutionFactor) * 100 
                    : 0;
            }

            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="back-button" onclick="renderClassicCocktails()">
                            <i class="fas fa-arrow-left"></i> Back to Classics
                        </button>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="editClassicCocktail(${cocktailId})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-outline" onclick="shareClassicCocktail(${cocktailId})">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                        <button class="favorite-btn" onclick="toggleClassicFavorite(${cocktailId})" 
                                style="background: none; border: 1px solid ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'}; padding: 0.75rem 1.5rem; border-radius: 10px; color: ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'};">
                            <i class="fa${cocktail.favorite ? 's' : 'r'} fa-star"></i> Favorite
                        </button>
                    </div>
                </div>

                <div class="cocktail-detail-page">
                    <div class="cocktail-silhouette">
                        <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="silhouette">
                    </div>

                    <div class="detail-content">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="${cocktail.name}" id="cocktailDetailImage">
                                <div class="image-upload-btn">
                                    <input type="file" accept="image/*" onchange="uploadClassicCocktailImage(${cocktailId}, event)" style="display: none;" id="classicImageUpload">
                                    <button class="btn btn-outline" style="padding: 0.5rem;" onclick="document.getElementById('classicImageUpload').click()">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="detail-title">
                                <div class="detail-name">${cocktail.name}</div>
                                <div class="detail-venue">
                                    <i class="fas fa-book"></i> Classic Cocktail
                                    <span style="margin-left: 1rem; background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.875rem;">
                                        ${cocktail.family || 'Classic'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-item">
                                <span class="info-item-label">Glassware</span>
                                <span class="info-item-value">${cocktail.glassware}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Garnish</span>
                                <span class="info-item-value">${cocktail.garnish}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Final ABV</span>
                                <span class="info-item-value">${cocktail.finalAbv.toFixed(1)}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Added</span>
                                <span class="info-item-value">${cocktail.dateAdded || '2024-01-15'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Author</span>
                                <span class="info-item-value">${cocktail.author || 'Classic Recipe'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label selling-price">Selling Price</span>
                                <span class="info-item-value selling-price">$${cocktail.sellingPrice}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">COGS</span>
                                <span class="info-item-value" style="color: ${cocktail.cogs < 20 ? 'var(--success)' : cocktail.cogs < 25 ? '#F39C12' : 'var(--danger)'};">
                                    ${cocktail.cogs}%
                                </span>
                            </div>
                        </div>

                        <div class="recipe-section">
                            <div class="section-title">
                                <i class="fas fa-flask"></i> Recipe
                            </div>

                            <table class="recipe-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">Omit</th>
                                        <th>Ingredient</th>
                                        <th>Amount</th>
                                        <th>Unit</th>
                                        <th>Pour Cost</th>
                                        <th>ABV</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cocktail.recipe.map((item, index) => {
                                        const isOmitted = AppState.omittedIngredients.includes(`${cocktailId}-${index}`);
                                        return `
                                            <tr style="${isOmitted ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                                                <td>
                                                    <input type="checkbox" class="omit-checkbox" 
                                                           ${isOmitted ? 'checked' : ''}
                                                           onchange="toggleClassicOmitIngredient(${cocktailId}, ${index}, this.checked)">
                                                </td>
                                                <td>
                                                    <span class="ingredient-reference" onclick="showIngredientReference('${item.spiritId || ''}', '${item.ingredient}')">
                                                        ${item.ingredient}
                                                    </span>
                                                </td>
                                                <td>${item.amount}</td>
                                                <td>${item.unit}</td>
                                                <td>$${item.pourCost ? item.pourCost.toFixed(2) : '0.00'}</td>
                                                <td>${item.abv}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>

                            <div class="method-section">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-flask" style="color: var(--accent);"></i>
                                    <span style="font-weight: 600; color: var(--primary);">Method</span>
                                </div>
                                <p style="color: var(--dark); line-height: 1.6;">${cocktail.method}</p>
                            </div>

                            ${cocktail.notes ? `
                                <div class="notes-section">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-sticky-note" style="color: var(--accent);"></i>
                                        <span style="font-weight: 600; color: var(--primary);">Notes</span>
                                    </div>
                                    <p style="color: var(--dark); line-height: 1.6;">${cocktail.notes}</p>
                                </div>
                            ` : ''}

                            <!-- SCALE RECIPE SECTION - FULL BATCH CALCULATOR -->
                            <div class="scale-section">
                                <div class="scale-title">
                                    <i class="fas fa-calculator"></i> SCALE RECIPE
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">1</div>
                                        <div class="step-title">CHOOSE SCALING METHOD</div>
                                    </div>
                                    <div class="scale-options">
                                        <div class="scale-option ${AppState.scaleMethod === 'serving' ? 'active' : ''}" onclick="setClassicScaleMethod('serving', ${cocktailId})">
                                            <div class="scale-option-title">SCALE BY NUMBER OF SERVINGS</div>
                                            <div class="scale-option-desc">Choose this if you know how many servings you need.</div>
                                        </div>
                                        <div class="scale-option ${AppState.scaleMethod === 'volume' ? 'active' : ''}" onclick="setClassicScaleMethod('volume', ${cocktailId})">
                                            <div class="scale-option-title">SCALE BY TOTAL VOLUME (ML)</div>
                                            <div class="scale-option-desc">Ideal for filling a specific container or batch size.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">2</div>
                                        <div class="step-title">ENTER QUANTITY</div>
                                    </div>
                                    <div class="quantity-input-group">
                                        <input type="number" id="scaleQuantityInput" class="quantity-input" 
                                               value="${AppState.scaleQuantity}" min="0.1" step="0.1" 
                                               onchange="updateClassicScaleQuantity(this.value, ${cocktailId})">
                                        <span class="quantity-label">${AppState.scaleMethod === 'serving' ? 'SERVINGS' : 'MILLILITERS (ML)'}</span>
                                    </div>
                                    <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="includeWaterCheckbox" 
                                                   ${AppState.includeWater ? 'checked' : ''} 
                                                   onchange="toggleClassicIncludeWater(${cocktailId})"
                                                   style="accent-color: var(--accent);">
                                            <span>Add water for dilution</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">3</div>
                                        <div class="step-title">ADD DILUTION (OPTIONAL)</div>
                                    </div>
                                    <div class="dilution-options">
                                        <div class="dilution-card ${AppState.dilutionType === 'none' ? 'active' : ''}" onclick="setClassicDilutionType('none', ${cocktailId})">
                                            <div class="dilution-percentage">0%</div>
                                            <div class="dilution-desc">NO DILUTION</div>
                                            <div class="dilution-desc">Best if you plan to shake or stir to order.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'spirit-driven' ? 'active' : ''}" onclick="setClassicDilutionType('spirit-driven', ${cocktailId})">
                                            <div class="dilution-percentage">18%</div>
                                            <div class="dilution-desc">SPIRIT-DRIVEN</div>
                                            <div class="dilution-desc">Best for strong drinks containing mainly spirits.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'shake' ? 'active' : ''}" onclick="setClassicDilutionType('shake', ${cocktailId})">
                                            <div class="dilution-percentage">25%</div>
                                            <div class="dilution-desc">SHAKEN COCKTAILS</div>
                                            <div class="dilution-desc">Ideal for cocktails with fruit juices, dairy, or eggs.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'stir' ? 'active' : ''}" onclick="setClassicDilutionType('stir', ${cocktailId})">
                                            <div class="dilution-percentage">20%</div>
                                            <div class="dilution-desc">STIRRED</div>
                                            <div class="dilution-desc">Perfect for spirit-forward cocktails.</div>
                                        </div>
                                    </div>
                                    <div class="custom-dilution-group">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" ${AppState.dilutionType === 'custom' ? 'checked' : ''} onchange="toggleClassicCustomDilutionType(this.checked, ${cocktailId})">
                                            <span>CUSTOM DILUTION</span>
                                        </label>
                                        <input type="number" id="customDilutionInput" 
                                               value="${(AppState.customDilution * 100).toFixed(0)}" 
                                               min="0" max="100" step="1" 
                                               style="width: 80px; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;"
                                               ${AppState.dilutionType !== 'custom' ? 'disabled' : ''}
                                               onchange="setClassicCustomDilution(this.value, ${cocktailId})">
                                        <span>%</span>
                                    </div>
                                </div>

                                <button class="calculate-btn" onclick="calculateClassicScaledRecipe(${cocktailId})">
                                    <i class="fas fa-calculator"></i> CALCULATE SCALED RECIPE
                                </button>

                                ${AppState.showScaledResults ? `
                                    <div class="scaled-results">
                                        <h4 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.1rem;">
                                            Scaled Recipe (${scaleFactor.toFixed(2)}x)
                                        </h4>
                                        
                                        ${dilutionFactor > 0 && AppState.includeWater ? `
                                            <div class="water-note">
                                                <i class="fas fa-tint"></i> Dilution: ${(dilutionFactor * 100).toFixed(0)}% ‚Ä¢ Water added: ${waterAmount.toFixed(0)}ml
                                            </div>
                                        ` : ''}
                                        
                                        ${AppState.scaleMethod === 'volume' ? `
                                            <div class="serving-note">
                                                <i class="fas fa-users"></i> This batch yields approximately ${servingsFromVolume} servings (based on 150ml per serving)
                                            </div>
                                        ` : ''}
                                        
                                        <table class="recipe-table">
                                            <thead>
                                                <tr>
                                                    <th>Ingredient</th>
                                                    <th>Single</th>
                                                    <th>Batch (ml)</th>
                                                    <th>Batch Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${scaledRecipe.map(item => `
                                                    <tr>
                                                        <td>${item.ingredient} ${item.isWater ? 'üíß' : ''}</td>
                                                        <td>${item.amount || '-'}</td>
                                                        <td style="font-weight: 700; color: var(--accent);">${item.scaledAmount}</td>
                                                        <td>$${(item.pourCost * scaleFactor).toFixed(2)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1.5rem;">
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Total Volume</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${totalVolume.toFixed(0)}ml</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Batch Cost</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchCost.toFixed(2)}</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Batch Revenue</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchRevenue.toFixed(2)}</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Final ABV</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${finalAbv.toFixed(1)}%</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                            <button class="btn btn-share" onclick="shareClassicCocktail(${cocktailId})" style="flex: 1;">
                                                <i class="fas fa-share-alt"></i> Share Recipe
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Scale Functions for Classic Cocktails
        function setClassicScaleMethod(method, cocktailId) {
            AppState.scaleMethod = method;
            AppState.scaleQuantity = method === 'serving' ? 1 : 1000;
            renderClassicCocktailDetailPage(cocktailId);
        }

        function updateClassicScaleQuantity(value, cocktailId) {
            AppState.scaleQuantity = parseFloat(value) || 0;
            renderClassicCocktailDetailPage(cocktailId);
        }

        function setClassicDilutionType(type, cocktailId) {
            AppState.dilutionType = type;
            renderClassicCocktailDetailPage(cocktailId);
        }

        function setClassicCustomDilution(value, cocktailId) {
            AppState.dilutionType = 'custom';
            AppState.customDilution = parseFloat(value) / 100;
            renderClassicCocktailDetailPage(cocktailId);
        }

        function toggleClassicCustomDilutionType(checked, cocktailId) {
            if (checked) {
                AppState.dilutionType = 'custom';
            } else {
                AppState.dilutionType = 'none';
            }
            renderClassicCocktailDetailPage(cocktailId);
        }

        function toggleClassicIncludeWater(cocktailId) {
            AppState.includeWater = !AppState.includeWater;
            renderClassicCocktailDetailPage(cocktailId);
        }

        function toggleClassicOmitIngredient(cocktailId, index, isOmitted) {
            const key = `${cocktailId}-${index}`;
            if (isOmitted) {
                if (!AppState.omittedIngredients.includes(key)) {
                    AppState.omittedIngredients.push(key);
                }
            } else {
                AppState.omittedIngredients = AppState.omittedIngredients.filter(k => k !== key);
            }
            renderClassicCocktailDetailPage(cocktailId);
        }

        function calculateClassicScaledRecipe(cocktailId) {
            AppState.showScaledResults = true;
            renderClassicCocktailDetailPage(cocktailId);
        }

        function renderCocktailDetailPage(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;

            let dilutionFactor = AppState.dilutionPresets[AppState.dilutionType] || 0;
            if (AppState.dilutionType === 'custom') {
                dilutionFactor = AppState.customDilution;
            }

            const activeRecipe = cocktail.recipe.filter((item, index) => 
                !AppState.omittedIngredients.includes(`${cocktailId}-${index}`)
            );

            const totalPreDilutionVolume = activeRecipe.reduce((acc, item) => {
                if (item.unit === 'ml') return acc + item.amount;
                if (item.unit === 'dash') return acc + (item.amount * DASH_TO_ML);
                if (item.unit === 'oz') return acc + (item.amount * 29.5735);
                return acc;
            }, 0);

            const scaleFactor = AppState.scaleMethod === 'serving' 
                ? AppState.scaleQuantity / (cocktail.batchSize || 1)
                : AppState.scaleQuantity / totalPreDilutionVolume;
            
            const waterAmount = AppState.showScaledResults && dilutionFactor > 0 ? totalPreDilutionVolume * dilutionFactor * scaleFactor : 0;
            
            let scaledRecipe = [];
            let totalVolume = 0;
            let batchCost = 0;
            let batchRevenue = 0;
            let finalAbv = 0;
            let servingsFromVolume = 0;
            
            if (AppState.showScaledResults) {
                scaledRecipe = activeRecipe.map(item => ({
                    ...item,
                    scaledAmount: (item.amount * scaleFactor).toFixed(1)
                }));

                if (AppState.includeWater && waterAmount > 0) {
                    scaledRecipe.push({
                        ingredient: "Water (dilution)",
                        amount: 0,
                        scaledAmount: waterAmount.toFixed(1),
                        unit: "ml",
                        pourCost: 0,
                        abv: 0,
                        isWater: true
                    });
                }

                totalVolume = scaledRecipe.reduce((acc, item) => acc + parseFloat(item.scaledAmount), 0);
                batchCost = activeRecipe.reduce((acc, item) => acc + (item.pourCost * scaleFactor), 0);
                batchRevenue = (cocktail.sellingPrice * (AppState.scaleMethod === 'serving' ? AppState.scaleQuantity : totalVolume / 150));
                servingsFromVolume = Math.round(totalVolume / 150);
                
                const totalAlcohol = activeRecipe.reduce((acc, item) => {
                    let amount = item.amount;
                    if (item.unit === 'dash') {
                        amount = amount * DASH_TO_ML;
                    }
                    return acc + (amount * (item.abv / 100));
                }, 0);
                
                finalAbv = totalPreDilutionVolume > 0 
                    ? (totalAlcohol / totalPreDilutionVolume) / (1 + dilutionFactor) * 100 
                    : 0;
            }

            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="back-button" onclick="selectVenue(${venueId})">
                            <i class="fas fa-arrow-left"></i> Back to ${venue.name}
                        </button>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="editCocktail(${venueId}, ${cocktailId})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-outline" onclick="shareCocktail(${venueId}, ${cocktailId})">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                        <button class="favorite-btn" onclick="toggleFavorite(${venueId}, ${cocktailId})" 
                                style="background: none; border: 1px solid ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'}; padding: 0.75rem 1.5rem; border-radius: 10px; color: ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'};">
                            <i class="fa${cocktail.favorite ? 's' : 'r'} fa-star"></i> Favorite
                        </button>
                    </div>
                </div>

                <div class="cocktail-detail-page">
                    <div class="cocktail-silhouette">
                        <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="silhouette">
                    </div>

                    <div class="detail-content">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="${cocktail.name}" id="cocktailDetailImage">
                                <div class="image-upload-btn">
                                    <input type="file" accept="image/*" onchange="uploadCocktailImage(${venueId}, ${cocktailId}, event)" style="display: none;" id="imageUpload">
                                    <button class="btn btn-outline" style="padding: 0.5rem;" onclick="document.getElementById('imageUpload').click()">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="detail-title">
                                <div class="detail-name">${cocktail.name}</div>
                                <div class="detail-venue">
                                    <i class="fas fa-store"></i> ${venue.name}
                                    <span style="margin-left: 1rem; background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.875rem;">
                                        ${cocktail.family || 'Signature'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-item">
                                <span class="info-item-label">Glassware</span>
                                <span class="info-item-value">${cocktail.glassware}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Garnish</span>
                                <span class="info-item-value">${cocktail.garnish}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Final ABV</span>
                                <span class="info-item-value">${cocktail.finalAbv.toFixed(1)}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Added</span>
                                <span class="info-item-value">${cocktail.dateAdded || '2024-01-15'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Author</span>
                                <span class="info-item-value">${cocktail.author || 'Bar Manager'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label selling-price">Selling Price</span>
                                <span class="info-item-value selling-price">$${cocktail.sellingPrice}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">COGS</span>
                                <span class="info-item-value" style="color: ${cocktail.cogs < 20 ? 'var(--success)' : cocktail.cogs < 25 ? '#F39C12' : 'var(--danger)'};">
                                    ${cocktail.cogs}%
                                </span>
                            </div>
                        </div>

                        <div class="recipe-section">
                            <div class="section-title">
                                <i class="fas fa-flask"></i> Recipe
                            </div>

                            <table class="recipe-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">Omit</th>
                                        <th>Ingredient</th>
                                        <th>Amount</th>
                                        <th>Unit</th>
                                        <th>Pour Cost</th>
                                        <th>ABV</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cocktail.recipe.map((item, index) => {
                                        const isOmitted = AppState.omittedIngredients.includes(`${cocktailId}-${index}`);
                                        return `
                                            <tr style="${isOmitted ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                                                <td>
                                                    <input type="checkbox" class="omit-checkbox" 
                                                           ${isOmitted ? 'checked' : ''}
                                                           onchange="toggleOmitIngredient(${venueId}, ${cocktailId}, ${index}, this.checked)">
                                                </td>
                                                <td>
                                                    <span class="ingredient-reference" onclick="showIngredientReference('${item.spiritId || ''}', '${item.ingredient}')">
                                                        ${item.ingredient}
                                                    </span>
                                                </td>
                                                <td>${item.amount}</td>
                                                <td>${item.unit}</td>
                                                <td>$${item.pourCost ? item.pourCost.toFixed(2) : '0.00'}</td>
                                                <td>${item.abv}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>

                            <div class="method-section">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-flask" style="color: var(--accent);"></i>
                                    <span style="font-weight: 600; color: var(--primary);">Method</span>
                                </div>
                                <p style="color: var(--dark); line-height: 1.6;">${cocktail.method}</p>
                            </div>

                            ${cocktail.notes ? `
                                <div class="notes-section">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-sticky-note" style="color: var(--accent);"></i>
                                        <span style="font-weight: 600; color: var(--primary);">Notes</span>
                                    </div>
                                    <p style="color: var(--dark); line-height: 1.6;">${cocktail.notes}</p>
                                </div>
                            ` : ''}

                            <!-- SCALE RECIPE SECTION - FULL BATCH CALCULATOR -->
                            <div class="scale-section">
                                <div class="scale-title">
                                    <i class="fas fa-calculator"></i> SCALE RECIPE
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">1</div>
                                        <div class="step-title">CHOOSE SCALING METHOD</div>
                                    </div>
                                    <div class="scale-options">
                                        <div class="scale-option ${AppState.scaleMethod === 'serving' ? 'active' : ''}" onclick="setScaleMethod('serving', ${venueId}, ${cocktailId})">
                                            <div class="scale-option-title">SCALE BY NUMBER OF SERVINGS</div>
                                            <div class="scale-option-desc">Choose this if you know how many servings you need.</div>
                                        </div>
                                        <div class="scale-option ${AppState.scaleMethod === 'volume' ? 'active' : ''}" onclick="setScaleMethod('volume', ${venueId}, ${cocktailId})">
                                            <div class="scale-option-title">SCALE BY TOTAL VOLUME (ML)</div>
                                            <div class="scale-option-desc">Ideal for filling a specific container or batch size.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">2</div>
                                        <div class="step-title">ENTER QUANTITY</div>
                                    </div>
                                    <div class="quantity-input-group">
                                        <input type="number" id="scaleQuantityInput" class="quantity-input" 
                                               value="${AppState.scaleQuantity}" min="0.1" step="0.1" 
                                               onchange="updateScaleQuantity(this.value, ${venueId}, ${cocktailId})">
                                        <span class="quantity-label">${AppState.scaleMethod === 'serving' ? 'SERVINGS' : 'MILLILITERS (ML)'}</span>
                                    </div>
                                    <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="includeWaterCheckbox" 
                                                   ${AppState.includeWater ? 'checked' : ''} 
                                                   onchange="toggleIncludeWater(${venueId}, ${cocktailId})"
                                                   style="accent-color: var(--accent);">
                                            <span>Add water for dilution</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">3</div>
                                        <div class="step-title">ADD DILUTION (OPTIONAL)</div>
                                    </div>
                                    <div class="dilution-options">
                                        <div class="dilution-card ${AppState.dilutionType === 'none' ? 'active' : ''}" onclick="setDilutionType('none', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">0%</div>
                                            <div class="dilution-desc">NO DILUTION</div>
                                            <div class="dilution-desc">Best if you plan to shake or stir to order.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'spirit-driven' ? 'active' : ''}" onclick="setDilutionType('spirit-driven', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">18%</div>
                                            <div class="dilution-desc">SPIRIT-DRIVEN</div>
                                            <div class="dilution-desc">Best for strong drinks containing mainly spirits.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'shake' ? 'active' : ''}" onclick="setDilutionType('shake', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">25%</div>
                                            <div class="dilution-desc">SHAKEN COCKTAILS</div>
                                            <div class="dilution-desc">Ideal for cocktails with fruit juices, dairy, or eggs.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'stir' ? 'active' : ''}" onclick="setDilutionType('stir', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">20%</div>
                                            <div class="dilution-desc">STIRRED</div>
                                            <div class="dilution-desc">Perfect for spirit-forward cocktails.</div>
                                        </div>
                                    </div>
                                    <div class="custom-dilution-group">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" ${AppState.dilutionType === 'custom' ? 'checked' : ''} onchange="toggleCustomDilutionType(this.checked, ${venueId}, ${cocktailId})">
                                            <span>CUSTOM DILUTION</span>
                                        </label>
                                        <input type="number" id="customDilutionInput" 
                                               value="${(AppState.customDilution * 100).toFixed(0)}" 
                                               min="0" max="100" step="1" 
                                               style="width: 80px; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;"
                                               ${AppState.dilutionType !== 'custom' ? 'disabled' : ''}
                                               onchange="setCustomDilution(this.value, ${venueId}, ${cocktailId})">
                                        <span>%</span>
                                    </div>
                                </div>

                                <button class="calculate-btn" onclick="calculateScaledRecipe(${venueId}, ${cocktailId})">
                                    <i class="fas fa-calculator"></i> CALCULATE SCALED RECIPE
                                </button>

                                ${AppState.showScaledResults ? `
                                    <div class="scaled-results">
                                        <h4 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.1rem;">
                                            Scaled Recipe (${scaleFactor.toFixed(2)}x)
                                        </h4>
                                        
                                        ${dilutionFactor > 0 && AppState.includeWater ? `
                                            <div class="water-note">
                                                <i class="fas fa-tint"></i> Dilution: ${(dilutionFactor * 100).toFixed(0)}% ‚Ä¢ Water added: ${waterAmount.toFixed(0)}ml
                                            </div>
                                        ` : ''}
                                        
                                        ${AppState.scaleMethod === 'volume' ? `
                                            <div class="serving-note">
                                                <i class="fas fa-users"></i> This batch yields approximately ${servingsFromVolume} servings (based on 150ml per serving)
                                            </div>
                                        ` : ''}
                                        
                                        <table class="recipe-table">
                                            <thead>
                                                <tr>
                                                    <th>Ingredient</th>
                                                    <th>Single</th>
                                                    <th>Batch (ml)</th>
                                                    <th>Batch Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${scaledRecipe.map(item => `
                                                    <tr>
                                                        <td>${item.ingredient} ${item.isWater ? 'üíß' : ''}</td>
                                                        <td>${item.amount || '-'}</td>
                                                        <td style="font-weight: 700; color: var(--accent);">${item.scaledAmount}</td>
                                                        <td>$${(item.pourCost * scaleFactor).toFixed(2)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1.5rem;">
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Total Volume</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${totalVolume.toFixed(0)}ml</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Batch Cost</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchCost.toFixed(2)}</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Batch Revenue</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchRevenue.toFixed(2)}</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray);">Final ABV</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${finalAbv.toFixed(1)}%</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                            <button class="btn btn-share" onclick="shareCocktail(${venueId}, ${cocktailId})" style="flex: 1;">
                                                <i class="fas fa-share-alt"></i> Share Recipe
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Scale Functions for Venue Cocktails
        function setScaleMethod(method, venueId, cocktailId) {
            AppState.scaleMethod = method;
            AppState.scaleQuantity = method === 'serving' ? 1 : 1000;
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function updateScaleQuantity(value, venueId, cocktailId) {
            AppState.scaleQuantity = parseFloat(value) || 0;
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function setDilutionType(type, venueId, cocktailId) {
            AppState.dilutionType = type;
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function setCustomDilution(value, venueId, cocktailId) {
            AppState.dilutionType = 'custom';
            AppState.customDilution = parseFloat(value) / 100;
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function toggleCustomDilutionType(checked, venueId, cocktailId) {
            if (checked) {
                AppState.dilutionType = 'custom';
            } else {
                AppState.dilutionType = 'none';
            }
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function toggleIncludeWater(venueId, cocktailId) {
            AppState.includeWater = !AppState.includeWater;
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function toggleOmitIngredient(venueId, cocktailId, index, isOmitted) {
            const key = `${cocktailId}-${index}`;
            if (isOmitted) {
                if (!AppState.omittedIngredients.includes(key)) {
                    AppState.omittedIngredients.push(key);
                }
            } else {
                AppState.omittedIngredients = AppState.omittedIngredients.filter(k => k !== key);
            }
            renderCocktailDetailPage(venueId, cocktailId);
        }

        function calculateScaledRecipe(venueId, cocktailId) {
            AppState.showScaledResults = true;
            renderCocktailDetailPage(venueId, cocktailId);
        }

        // Share Cocktail
        function shareCocktail(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue?.cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            const recipeText = cocktail.recipe.map(item => `‚Ä¢ ${item.amount}${item.unit} ${item.ingredient}`).join('\n');
            const message = encodeURIComponent(
                `*${cocktail.name}*\n` +
                `${venue.name} ‚Ä¢ ${cocktail.family || 'Signature'}\n` +
                `\n*Recipe:*\n${recipeText}\n` +
                `\n*Glassware:* ${cocktail.glassware}\n` +
                `*Garnish:* ${cocktail.garnish}\n` +
                `*ABV:* ${cocktail.finalAbv.toFixed(1)}%\n` +
                `*Price:* $${cocktail.sellingPrice}\n` +
                `*COGS:* ${cocktail.cogs}%\n` +
                `\n*Method:*\n${cocktail.method}`
            );
            window.open(`https://wa.me/?text=${message}`, '_blank');
            showToast('‚úÖ Recipe shared via WhatsApp');
        }

        // Share Classic Cocktail
        function shareClassicCocktail(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            const recipeText = cocktail.recipe.map(item => `‚Ä¢ ${item.amount}${item.unit} ${item.ingredient}`).join('\n');
            const message = encodeURIComponent(
                `*${cocktail.name}* (Classic)\n` +
                `Family: ${cocktail.family || 'Classic'}\n` +
                `\n*Recipe:*\n${recipeText}\n` +
                `\n*Glassware:* ${cocktail.glassware}\n` +
                `*Garnish:* ${cocktail.garnish}\n` +
                `*ABV:* ${cocktail.finalAbv.toFixed(1)}%\n` +
                `*Price:* $${cocktail.sellingPrice}\n` +
                `*COGS:* ${cocktail.cogs}%\n` +
                `\n*Method:*\n${cocktail.method}`
            );
            window.open(`https://wa.me/?text=${message}`, '_blank');
            showToast('‚úÖ Classic recipe shared via WhatsApp');
        }

        // Toggle Favorite for venue cocktails
        async function toggleFavorite(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue?.cocktails.find(c => c.id === cocktailId);
            if (cocktail) {
                cocktail.favorite = !cocktail.favorite;
                await saveAllData();
                showToast(cocktail.favorite ? '‚≠ê Added to favorites' : 'Removed from favorites');
                if (AppState.currentView === 'cocktails' && AppState.selectedVenue === venueId) {
                    selectVenue(venueId);
                } else if (AppState.currentView === 'detail' && AppState.selectedCocktail === cocktailId) {
                    renderCocktailDetailPage(venueId, cocktailId);
                }
                updateFavoritesList();
            }
        }

        // Toggle Favorite for classic cocktails
        async function toggleClassicFavorite(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            if (cocktail) {
                cocktail.favorite = !cocktail.favorite;
                await saveAllData();
                showToast(cocktail.favorite ? '‚≠ê Added to favorites' : 'Removed from favorites');
                if (AppState.currentView === 'classic-detail' && AppState.selectedClassicCocktail === cocktailId) {
                    renderClassicCocktailDetailPage(cocktailId);
                } else {
                    renderClassicCocktails();
                }
            }
        }

        // Edit Cocktail (venue)
        function editCocktail(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue?.cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            openAddCocktailModal();
            document.getElementById('venueSelectionField').style.display = 'none';
            document.getElementById('cocktailVenue').value = venueId;
            document.getElementById('cocktailName').value = cocktail.name;
            document.getElementById('cocktailFamily').value = cocktail.family || 'Signature';
            document.getElementById('cocktailSellingPrice').value = cocktail.sellingPrice;
            document.getElementById('cocktailGlass').value = cocktail.glassware;
            document.getElementById('cocktailGarnish').value = cocktail.garnish;
            document.getElementById('cocktailMethod').value = cocktail.method || '';
            document.getElementById('cocktailNotes').value = cocktail.notes || '';
            
            const dilutionPreset = cocktail.dilutionPreset || 'none';
            document.querySelectorAll('input[name="dilutionPreset"]').forEach(radio => {
                radio.checked = radio.value === dilutionPreset;
            });
            
            const tbody = document.getElementById('ingredientTableBody');
            tbody.innerHTML = '';
            
            cocktail.recipe.forEach(item => {
                const newRow = document.createElement('tr');
                newRow.className = 'ingredient-row';
                newRow.innerHTML = `
                    <td class="ingredient-search">
                        <input type="text" value="${item.ingredient}" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                        <div class="autocomplete-list" id="autocomplete-${Date.now()}"></div>
                    </td>
                    <td><input type="number" value="${item.bottleSize || 750}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.bottleCost || 0}" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.amount}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td>
                        <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                            <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>ml</option>
                            <option value="dash" ${item.unit === 'dash' ? 'selected' : ''}>dash</option>
                        </select>
                    </td>
                    <td><input type="number" value="${item.pourCost || 0}" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                    <td><input type="number" value="${item.abv || 40}" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                    <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(newRow);
                
                if (item.spiritId) newRow.dataset.spiritId = item.spiritId;
                const pour = item.unit === 'dash' ? item.amount * DASH_TO_ML : item.amount;
                const pourCost = (pour / (item.bottleSize || 750)) * (item.bottleCost || 0);
                newRow.cells[5].querySelector('input').value = pourCost.toFixed(3);
            });
            
            addIngredientRow();
            calculateTotalPourCost();
            calculateFinalABV();
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = (e) => updateCocktail(e, venueId, cocktailId);
        }

        // Update Cocktail (venue)
        async function updateCocktail(event, venueId, cocktailId) {
            event.preventDefault();
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const unit = unitSelect?.value || 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    if (unit === 'dash') pourAmount *= DASH_TO_ML;
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit,
                        pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: row.dataset.spiritId || null
                    });
                }
            });
            
            cocktail.name = document.getElementById('cocktailName').value;
            cocktail.family = document.getElementById('cocktailFamily').value;
            cocktail.recipe = recipe;
            cocktail.pourCost = totalPourCost;
            cocktail.sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value);
            cocktail.cogs = ((totalPourCost / cocktail.sellingPrice) * 100).toFixed(1);
            cocktail.method = document.getElementById('cocktailMethod').value;
            cocktail.garnish = document.getElementById('cocktailGarnish').value;
            cocktail.glassware = document.getElementById('cocktailGlass').value;
            cocktail.notes = document.getElementById('cocktailNotes').value;
            
            const selected = document.querySelector('input[name="dilutionPreset"]:checked');
            cocktail.dilutionPreset = selected?.value || 'none';
            
            closeModal('addCocktailModal');
            await saveAllData();
            renderCocktailDetailPage(venueId, cocktailId);
            showToast(`‚úÖ ${cocktail.name} updated`);
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = saveNewCocktail;
            document.getElementById('venueSelectionField').style.display = 'block';
        }

        // CLASSIC COCKTAILS - Updated with working click handlers and detail page
        function renderClassicCocktails() {
            const sortedClassics = [...AppState.classicCocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            // Apply search filter
            const filteredClassics = AppState.classicSearchTerm 
                ? sortedClassics.filter(c => c.name.toLowerCase().includes(AppState.classicSearchTerm.toLowerCase()) ||
                                           c.family.toLowerCase().includes(AppState.classicSearchTerm.toLowerCase()))
                : sortedClassics;
            
            // Group by first letter for alphabetical navigation
            const grouped = {};
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            alphabet.forEach(letter => grouped[letter] = filteredClassics.filter(c => c.name.charAt(0).toUpperCase() === letter));

            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h1 class="page-title" style="margin-left: 0;">
                            <i class="fas fa-book"></i> Classic Cocktails
                        </h1>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="openAddClassicCocktailModal()">
                            <i class="fas fa-plus"></i> New Classic
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="quick-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search classic cocktails by name or family..." id="classicSearch" 
                           value="${AppState.classicSearchTerm || ''}" onkeyup="filterClassicList(this.value)">
                    ${AppState.classicSearchTerm ? `
                        <button class="btn btn-outline btn-sm" onclick="clearClassicSearch()" style="margin-left: 0.5rem;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    ` : ''}
                </div>

                <div class="alphabet-nav-container">
                    <div class="alphabet-content">
                        <div class="item-list">
                            ${alphabet.map(letter => {
                                const classics = grouped[letter];
                                if (classics?.length) return `
                                    <div id="classic-letter-${letter}" style="margin-bottom: 1rem;">
                                        <div style="background: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 30px; display: inline-block; margin-bottom: 0.5rem; font-weight: 600;">
                                            ${letter} (${classics.length})
                                        </div>
                                        ${classics.map(cocktail => `
                                            <div class="classic-card" onclick="viewClassicCocktailDetail(${cocktail.id})">
                                                <div class="classic-image">
                                                    <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=100'}" alt="${cocktail.name}">
                                                    <div class="image-upload-btn" style="position: absolute; bottom: 5px; right: 5px;" onclick="event.stopPropagation(); document.getElementById('classicImageUpload_${cocktail.id}').click()">
                                                        <button class="btn btn-outline" style="padding: 0.15rem 0.3rem; font-size: 0.6rem;">
                                                            <i class="fas fa-camera"></i>
                                                        </button>
                                                        <input type="file" id="classicImageUpload_${cocktail.id}" accept="image/*" style="display: none;" onchange="uploadClassicCocktailImage(${cocktail.id}, event)">
                                                    </div>
                                                </div>
                                                <div class="classic-info">
                                                    <div class="classic-name">
                                                        ${cocktail.name}
                                                        <span class="family-tag">${cocktail.family}</span>
                                                        ${cocktail.favorite ? '<i class="fas fa-star favorite-star"></i>' : ''}
                                                    </div>
                                                    <div class="classic-meta">
                                                        <span><i class="fas fa-wine-glass"></i> ${cocktail.glassware}</span>
                                                        <span><i class="fas fa-leaf"></i> ${cocktail.garnish}</span>
                                                        <span><i class="fas fa-percent"></i> ${cocktail.finalAbv.toFixed(1)}% ABV</span>
                                                        <span class="classic-price-badge">$${cocktail.sellingPrice}</span>
                                                    </div>
                                                    <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.875rem;">
                                                        ${cocktail.recipe.length} ingredients ‚Ä¢ COGS: ${cocktail.cogs}%
                                                    </div>
                                                </div>
                                                <div class="classic-actions">
                                                    <button class="classic-action-btn" onclick="event.stopPropagation(); editClassicCocktail(${cocktail.id})">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="classic-action-btn classic-share-btn" onclick="event.stopPropagation(); shareClassicCocktail(${cocktail.id})">
                                                        <i class="fas fa-share-alt"></i>
                                                    </button>
                                                    <button class="classic-action-btn" onclick="event.stopPropagation(); toggleClassicFavorite(${cocktail.id})" 
                                                            style="border-color: var(--accent); color: var(--accent);">
                                                        <i class="fa${cocktail.favorite ? 's' : 'r'} fa-star"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                                return '';
                            }).join('')}
                            ${!filteredClassics.length ? `
                                <div style="background: var(--white); border-radius: 20px; padding: 3rem; text-align: center;">
                                    <i class="fas fa-book" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                                    <h3 style="color: var(--primary); margin-bottom: 0.5rem;">No Classics Found</h3>
                                    <p style="color: var(--gray); margin-bottom: 1.5rem;">${AppState.classicSearchTerm ? 'Try a different search term' : 'Create your first classic cocktail by clicking the button above.'}</p>
                                    ${AppState.classicSearchTerm ? `
                                        <button class="btn btn-outline" onclick="clearClassicSearch()">
                                            <i class="fas fa-times"></i> Clear Search
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Alphabet Navigation - Flutter style on right -->
                    <div class="alphabet-nav">
                        ${alphabet.map(letter => {
                            const hasItems = grouped[letter]?.length > 0;
                            return `
                                <div class="alphabet-letter ${hasItems ? '' : 'disabled'}" 
                                     style="${hasItems ? 'color: var(--accent); font-weight: 700;' : ''}"
                                     onclick="${hasItems ? `document.getElementById('classic-letter-${letter}')?.scrollIntoView({behavior: 'smooth', block: 'start'})` : ''}">
                                    ${letter}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Filter classic cocktails by search term
        function filterClassicList(searchTerm) {
            AppState.classicSearchTerm = searchTerm;
            renderClassicCocktails();
        }

        // Clear classic search
        function clearClassicSearch() {
            AppState.classicSearchTerm = '';
            renderClassicCocktails();
        }

        // Edit Classic Cocktail - Opens the same modal as signature cocktails
        function editClassicCocktail(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            openAddCocktailModal();
            document.getElementById('venueSelectionField').style.display = 'none';
            document.getElementById('cocktailName').value = cocktail.name;
            document.getElementById('cocktailFamily').value = cocktail.family || 'Classic';
            document.getElementById('cocktailSellingPrice').value = cocktail.sellingPrice;
            document.getElementById('cocktailGlass').value = cocktail.glassware;
            document.getElementById('cocktailGarnish').value = cocktail.garnish;
            document.getElementById('cocktailMethod').value = cocktail.method || '';
            document.getElementById('cocktailNotes').value = cocktail.notes || '';
            
            const dilutionPreset = cocktail.dilutionPreset || 'none';
            document.querySelectorAll('input[name="dilutionPreset"]').forEach(radio => {
                radio.checked = radio.value === dilutionPreset;
            });
            
            const tbody = document.getElementById('ingredientTableBody');
            tbody.innerHTML = '';
            
            cocktail.recipe.forEach(item => {
                const newRow = document.createElement('tr');
                newRow.className = 'ingredient-row';
                newRow.innerHTML = `
                    <td class="ingredient-search">
                        <input type="text" value="${item.ingredient}" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                        <div class="autocomplete-list" id="autocomplete-${Date.now()}"></div>
                    </td>
                    <td><input type="number" value="${item.bottleSize || 750}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.bottleCost || 0}" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.amount}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td>
                        <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                            <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>ml</option>
                            <option value="dash" ${item.unit === 'dash' ? 'selected' : ''}>dash</option>
                        </select>
                    </td>
                    <td><input type="number" value="${item.pourCost || 0}" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                    <td><input type="number" value="${item.abv || 40}" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                    <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(newRow);
                
                if (item.spiritId) newRow.dataset.spiritId = item.spiritId;
                const pour = item.unit === 'dash' ? item.amount * DASH_TO_ML : item.amount;
                const pourCost = (pour / (item.bottleSize || 750)) * (item.bottleCost || 0);
                newRow.cells[5].querySelector('input').value = pourCost.toFixed(3);
            });
            
            addIngredientRow();
            calculateTotalPourCost();
            calculateFinalABV();
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = (e) => updateClassicCocktail(e, cocktailId);
        }

        // Update Classic Cocktail
        async function updateClassicCocktail(event, cocktailId) {
            event.preventDefault();
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const unit = unitSelect?.value || 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    if (unit === 'dash') pourAmount *= DASH_TO_ML;
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit,
                        pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: row.dataset.spiritId || null
                    });
                }
            });
            
            cocktail.name = document.getElementById('cocktailName').value;
            cocktail.family = document.getElementById('cocktailFamily').value;
            cocktail.recipe = recipe;
            cocktail.pourCost = totalPourCost;
            cocktail.sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value);
            cocktail.cogs = ((totalPourCost / cocktail.sellingPrice) * 100).toFixed(1);
            cocktail.method = document.getElementById('cocktailMethod').value;
            cocktail.garnish = document.getElementById('cocktailGarnish').value;
            cocktail.glassware = document.getElementById('cocktailGlass').value;
            cocktail.notes = document.getElementById('cocktailNotes').value;
            
            const selected = document.querySelector('input[name="dilutionPreset"]:checked');
            cocktail.dilutionPreset = selected?.value || 'none';
            
            closeModal('addCocktailModal');
            await saveAllData();
            renderClassicCocktailDetailPage(cocktailId);
            showToast(`‚úÖ ${cocktail.name} updated`);
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = saveNewCocktail;
        }

        // Upload Classic Cocktail Image
        async function uploadClassicCocktailImage(cocktailId, event) {
            const file = event.target.files[0];
            if (file) {
                const path = `classic/${cocktailId}_${Date.now()}.jpg`;
                const url = await uploadImage(file, path);
                if (url) {
                    const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
                    if (cocktail) {
                        cocktail.image = url;
                        await saveAllData();
                        if (AppState.currentView === 'classic-detail' && AppState.selectedClassicCocktail === cocktailId) {
                            renderClassicCocktailDetailPage(cocktailId);
                        } else {
                            renderClassicCocktails();
                        }
                        showToast(`‚úÖ ${cocktail.name} image updated`);
                    }
                }
            }
        }

        // SPIRIT LIBRARY - Updated with simplified fields and no ABV refresh buttons
        function renderSpiritLibrary() {
            const spirits = AppState.spiritLibrary;
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-wine-bottle"></i> Spirit Library
                    </h1>
                    <div style="display: flex; gap: 1rem;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-outline" onclick="exportSpiritLibrary()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('excelImport').click()">
                            <i class="fas fa-file-import"></i> Import Excel
                        </button>
                        <input type="file" id="excelImport" accept=".xlsx, .xls, .csv" style="display: none;" onchange="importSpiritLibrary(event)">
                    </div>
                </div>

                <div class="spirit-library-container">
                    <div class="import-section">
                        <div class="import-area" onclick="document.getElementById('excelImport').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">Import Spirit Library</h3>
                            <p style="color: var(--gray); margin-bottom: 1rem;">Upload Excel file to update spirit database</p>
                            <p style="font-size: 0.875rem; color: var(--accent);">Supported formats: .xlsx, .xls, .csv</p>
                        </div>
                    </div>

                    <div class="spirit-filters">
                        <div class="filter-group">
                            <i class="fas fa-search"></i>
                            <input type="text" id="spiritSearch" class="filter-input" placeholder="Search by Category, Product, Size, Cost, ABV, Supplier..." onkeyup="filterSpiritLibrary()">
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--primary);">Current Spirit Inventory</h3>
                        <span style="background: var(--light); padding: 0.5rem 1rem; border-radius: 30px; font-weight: 600;" id="spiritCount">${spirits.length} items</span>
                    </div>

                    <table class="spirit-table" id="spiritTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Product</th>
                                <th>Size (ml)</th>
                                <th>Cost ($)</th>
                                <th>ABV (%)</th>
                                <th>Supplier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="spiritTableBody">
                            ${spirits.map(spirit => {
                                // Determine ABV class for color coding
                                let abvClass = 'abv-non';
                                const type = spirit.type.toLowerCase();
                                if (type.includes('gin') || type.includes('vodka') || type.includes('whiskey') || 
                                    type.includes('bourbon') || type.includes('scotch') || type.includes('rum') || 
                                    type.includes('tequila') || type.includes('brandy')) {
                                    abvClass = 'abv-spirit';
                                } else if (type.includes('liqueur')) {
                                    abvClass = 'abv-liqueur';
                                } else if (type.includes('bitters')) {
                                    abvClass = 'abv-bitters';
                                } else if (type.includes('vermouth') || type.includes('wine')) {
                                    abvClass = 'abv-wine';
                                }
                                
                                return `
                                    <tr data-spirit-id="${spirit.id}">
                                        <td>${spirit.type}</td>
                                        <td style="font-weight: 600;">${spirit.name}</td>
                                        <td>${spirit.bottleSize}ml</td>
                                        <td>$${spirit.bottleCost.toFixed(2)}</td>
                                        <td class="${abvClass}">${spirit.abv.toFixed(1)}%</td>
                                        <td>${spirit.supplier || '-'}</td>
                                        <td>
                                            <div class="spirit-actions">
                                                <button class="spirit-edit-btn" onclick="openSpiritEditModal('${spirit.id}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="spirit-delete-btn" onclick="deleteSpirit('${spirit.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Filter Spirit Library
        function filterSpiritLibrary() {
            const searchTerm = document.getElementById('spiritSearch')?.value.toLowerCase() || '';
            
            const filtered = AppState.spiritLibrary.filter(spirit => {
                return !searchTerm || 
                    spirit.name.toLowerCase().includes(searchTerm) ||
                    spirit.type.toLowerCase().includes(searchTerm) ||
                    spirit.bottleSize.toString().includes(searchTerm) ||
                    spirit.bottleCost.toString().includes(searchTerm) ||
                    spirit.abv.toString().includes(searchTerm) ||
                    (spirit.supplier && spirit.supplier.toLowerCase().includes(searchTerm));
            });
            
            const tbody = document.getElementById('spiritTableBody');
            if (tbody) {
                tbody.innerHTML = filtered.map(spirit => {
                    // Determine ABV class for color coding
                    let abvClass = 'abv-non';
                    const type = spirit.type.toLowerCase();
                    if (type.includes('gin') || type.includes('vodka') || type.includes('whiskey') || 
                        type.includes('bourbon') || type.includes('scotch') || type.includes('rum') || 
                        type.includes('tequila') || type.includes('brandy')) {
                        abvClass = 'abv-spirit';
                    } else if (type.includes('liqueur')) {
                        abvClass = 'abv-liqueur';
                    } else if (type.includes('bitters')) {
                        abvClass = 'abv-bitters';
                    } else if (type.includes('vermouth') || type.includes('wine')) {
                        abvClass = 'abv-wine';
                    }
                    
                    return `
                        <tr data-spirit-id="${spirit.id}">
                            <td>${spirit.type}</td>
                            <td style="font-weight: 600;">${spirit.name}</td>
                            <td>${spirit.bottleSize}ml</td>
                            <td>$${spirit.bottleCost.toFixed(2)}</td>
                            <td class="${abvClass}">${spirit.abv.toFixed(1)}%</td>
                            <td>${spirit.supplier || '-'}</td>
                            <td>
                                <div class="spirit-actions">
                                    <button class="spirit-edit-btn" onclick="openSpiritEditModal('${spirit.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="spirit-delete-btn" onclick="deleteSpirit('${spirit.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('spiritCount').textContent = `${filtered.length} items`;
            }
        }

        // Import Spirit Library - WORKS WITH ONEDRIVE
        async function importSpiritLibrary(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('üìÇ Reading file from OneDrive...');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: true,
                        sheetStubs: true,
                        raw: true
                    });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        defval: '',
                        blankrows: false,
                        raw: false
                    });

                    showToast('üîç Analyzing Excel structure...');

                    let headerRow = -1;
                    const possibleHeaders = ['category', 'product', 'size', 'cost', 'abv', 'supplier'];
                    
                    for (let i = 0; i < Math.min(jsonData.length, 20); i++) {
                        const row = jsonData[i];
                        if (!row || !Array.isArray(row)) continue;
                        const rowText = row.join(' ').toLowerCase();
                        if (possibleHeaders.some(h => rowText.includes(h))) {
                            headerRow = i;
                            break;
                        }
                    }

                    if (headerRow === -1 && jsonData.length > 0) {
                        headerRow = 0;
                    }

                    if (headerRow === -1) {
                        showToast('‚ùå Could not identify Excel structure');
                        return;
                    }

                    const headers = jsonData[headerRow].map(h => String(h || '').toLowerCase().trim());
                    
                    const categoryIdx = headers.findIndex(h => h.includes('category') || h.includes('type') || h.includes('spirit'));
                    const productIdx = headers.findIndex(h => h.includes('product') || h.includes('name'));
                    const sizeIdx = headers.findIndex(h => h.includes('size') || h.includes('volume') || h.includes('ml'));
                    const costIdx = headers.findIndex(h => h.includes('cost') || h.includes('price'));
                    const abvIdx = headers.findIndex(h => h.includes('abv') || h.includes('alcohol'));
                    const supplierIdx = headers.findIndex(h => h.includes('supplier') || h.includes('vendor'));

                    showToast(`üìä Found ${headers.length} columns`);

                    const newSpirits = [];
                    let importCount = 0;

                    for (let i = headerRow + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || !Array.isArray(row) || row.length === 0) continue;
                        if (row.every(cell => !cell || cell === '')) continue;
                        
                        let category = '';
                        if (categoryIdx >= 0 && row[categoryIdx]) {
                            category = String(row[categoryIdx]).trim();
                        }
                        
                        let product = '';
                        if (productIdx >= 0 && row[productIdx]) {
                            product = String(row[productIdx]).trim();
                        }
                        
                        if (!product) continue;

                        const parseFloatSafe = (val) => {
                            if (val === undefined || val === null || val === '') return null;
                            const str = String(val).replace(/[^0-9.-]/g, '');
                            const num = parseFloat(str);
                            return isNaN(num) ? null : num;
                        };

                        const size = parseFloatSafe(sizeIdx >= 0 ? row[sizeIdx] : null) || 750;
                        const cost = parseFloatSafe(costIdx >= 0 ? row[costIdx] : null) || 0;
                        const abv = parseFloatSafe(abvIdx >= 0 ? row[abvIdx] : null) || 0;

                        newSpirits.push({
                            id: `spirit-${Date.now()}-${importCount++}`,
                            name: product,
                            type: category || 'Spirit',
                            abv: abv,
                            bottleSize: size,
                            bottleCost: cost,
                            supplier: (supplierIdx >= 0 && row[supplierIdx]) ? String(row[supplierIdx]).trim() : '',
                            lastUpdated: new Date().toISOString().split('T')[0]
                        });
                    }

                    if (newSpirits.length > 0) {
                        AppState.spiritLibrary = [...AppState.spiritLibrary, ...newSpirits];
                        await saveAllData();
                        showToast(`‚úÖ Successfully imported ${newSpirits.length} items!`);
                        renderSpiritLibrary();
                        updateAllCocktailCosts();
                    } else {
                        showToast('‚ùå No valid spirit data found in file');
                    }
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('‚ùå Error importing file: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showToast('‚ùå Error reading file');
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // Export Spirit Library
        function exportSpiritLibrary() {
            const exportData = AppState.spiritLibrary.map(spirit => ({
                'Category': spirit.type,
                'Product': spirit.name,
                'Size (ml)': spirit.bottleSize,
                'Cost ($)': spirit.bottleCost.toFixed(2),
                'ABV (%)': spirit.abv.toFixed(1),
                'Supplier': spirit.supplier || ''
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, 'Spirit Library');
            XLSX.writeFile(wb, `Spirit_Library_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('‚úÖ Spirit library exported successfully');
        }

        // Get smart ABV based on category (kept for potential future use)
        function getSmartABV(category) {
            const type = category.toLowerCase();
            
            // Spirits (35-50%)
            if (type.includes('gin') || type.includes('vodka') || type.includes('whiskey') || 
                type.includes('bourbon') || type.includes('scotch') || type.includes('rum') || 
                type.includes('tequila') || type.includes('brandy') || type.includes('cognac')) {
                return 40 + Math.floor(Math.random() * 10); // 40-50%
            }
            
            // Liqueurs (15-30%)
            if (type.includes('liqueur') || type.includes('liquor')) {
                return 15 + Math.floor(Math.random() * 15); // 15-30%
            }
            
            // Bitters (35-45%)
            if (type.includes('bitters')) {
                return 35 + Math.floor(Math.random() * 10); // 35-45%
            }
            
            // Fortified Wines / Vermouth (15-22%)
            if (type.includes('vermouth') || type.includes('wine') || type.includes('port') || type.includes('sherry')) {
                return 15 + Math.floor(Math.random() * 7); // 15-22%
            }
            
            // Aperitifs (15-25%)
            if (type.includes('aperol') || type.includes('campari') || type.includes('aperitif')) {
                return 11 + Math.floor(Math.random() * 14); // 11-25%
            }
            
            // Non-alcoholic
            if (type.includes('syrup') || type.includes('juice') || type.includes('puree') || 
                type.includes('cordial') || type.includes('grenadine') || type.includes('orgeat')) {
                return 0;
            }
            
            // Default for unknown - assume spirit
            return 40;
        }

        // Edit Spirit
        function openSpiritEditModal(spiritId) {
            const spirit = AppState.spiritLibrary.find(s => s.id === spiritId);
            if (!spirit) return;
            
            document.getElementById('editSpiritId').value = spirit.id;
            document.getElementById('editSpiritName').value = spirit.name;
            document.getElementById('editSpiritType').value = spirit.type;
            document.getElementById('editSpiritABV').value = spirit.abv;
            document.getElementById('editSpiritBottleSize').value = spirit.bottleSize;
            document.getElementById('editSpiritBottleCost').value = spirit.bottleCost;
            document.getElementById('editSpiritSupplier').value = spirit.supplier || '';
            
            document.getElementById('spiritEditModal').style.display = 'flex';
        }

        function closeSpiritEditModal() {
            document.getElementById('spiritEditModal').style.display = 'none';
        }

        async function saveSpiritChanges(event) {
            event.preventDefault();
            
            const spiritId = document.getElementById('editSpiritId').value;
            const spirit = AppState.spiritLibrary.find(s => s.id === spiritId);
            
            if (spirit) {
                spirit.name = document.getElementById('editSpiritName').value;
                spirit.type = document.getElementById('editSpiritType').value;
                spirit.abv = parseFloat(document.getElementById('editSpiritABV').value);
                spirit.bottleSize = parseFloat(document.getElementById('editSpiritBottleSize').value);
                spirit.bottleCost = parseFloat(document.getElementById('editSpiritBottleCost').value);
                spirit.supplier = document.getElementById('editSpiritSupplier').value;
                spirit.lastUpdated = new Date().toISOString().split('T')[0];
                
                closeSpiritEditModal();
                await saveAllData();
                renderSpiritLibrary();
                updateAllCocktailCosts();
                showToast(`‚úÖ ${spirit.name} updated successfully`);
            }
        }

        // Delete Spirit
        async function deleteSpirit(spiritId) {
            if (confirm('Are you sure you want to delete this spirit?')) {
                const index = AppState.spiritLibrary.findIndex(s => s.id === spiritId);
                if (index !== -1) {
                    AppState.spiritLibrary.splice(index, 1);
                    await saveAllData();
                    renderSpiritLibrary();
                    updateAllCocktailCosts();
                    showToast('‚úÖ Spirit deleted');
                }
            }
        }

        // Update all cocktail costs
        function updateAllCocktailCosts() {
            AppState.venues.forEach(venue => {
                venue.cocktails.forEach(cocktail => {
                    cocktail.recipe.forEach(item => {
                        if (item.spiritId) {
                            const spirit = AppState.spiritLibrary.find(s => s.id === item.spiritId);
                            if (spirit) {
                                item.bottleSize = spirit.bottleSize;
                                item.bottleCost = spirit.bottleCost;
                                item.abv = spirit.abv;
                                item.pourCost = (item.amount / item.bottleSize) * item.bottleCost;
                            }
                        }
                    });
                    cocktail.pourCost = cocktail.recipe.reduce((sum, item) => sum + (item.pourCost || 0), 0);
                    cocktail.cogs = (cocktail.pourCost / cocktail.sellingPrice * 100).toFixed(1);
                });
            });

            AppState.classicCocktails.forEach(cocktail => {
                cocktail.recipe.forEach(item => {
                    if (item.spiritId) {
                        const spirit = AppState.spiritLibrary.find(s => s.id === item.spiritId);
                        if (spirit) {
                            item.bottleSize = spirit.bottleSize;
                            item.bottleCost = spirit.bottleCost;
                            item.abv = spirit.abv;
                            item.pourCost = (item.amount / item.bottleSize) * item.bottleCost;
                        }
                    }
                });
                cocktail.pourCost = cocktail.recipe.reduce((sum, item) => sum + (item.pourCost || 0), 0);
                cocktail.cogs = (cocktail.pourCost / cocktail.sellingPrice * 100).toFixed(1);
            });

            showToast('‚úÖ All cocktail costs updated from spirit library');
        }

        // Search ingredients
        function searchIngredients(input) {
            const searchTerm = input.value.toLowerCase();
            const autocompleteList = input.parentElement.querySelector('.autocomplete-list');
            
            if (searchTerm.length < 1) {
                autocompleteList.style.display = 'none';
                return;
            }

            const matches = AppState.spiritLibrary.filter(spirit => 
                spirit.name.toLowerCase().includes(searchTerm) || 
                spirit.type.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (matches.length > 0) {
                autocompleteList.innerHTML = matches.map(spirit => `
                    <div class="autocomplete-item" onclick="selectIngredient(this, '${spirit.id}', '${spirit.name}', ${spirit.bottleSize}, ${spirit.bottleCost}, ${spirit.abv})">
                        <strong>${spirit.name}</strong> - ${spirit.type}<br>
                        <small>${spirit.bottleSize}ml | $${spirit.bottleCost.toFixed(2)} | ${spirit.abv.toFixed(1)}% ABV</small>
                    </div>
                `).join('');
                autocompleteList.style.display = 'block';
            } else {
                autocompleteList.style.display = 'none';
            }
        }

        function selectIngredient(element, spiritId, name, bottleSize, bottleCost, abv) {
            const row = element.closest('tr');
            const inputs = row.querySelectorAll('input');
            
            inputs[0].value = name;
            inputs[1].value = bottleSize;
            inputs[2].value = bottleCost;
            inputs[6].value = abv;
            row.dataset.spiritId = spiritId;
            
            element.parentElement.querySelector('.autocomplete-list').style.display = 'none';
            calculateIngredientCost(inputs[3]);
            showToast(`‚úÖ Selected ${name} from Spirit Library`);
        }

        // Venue Functions
        function editVenue(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            if (venue) {
                document.getElementById('editVenueId').value = venue.id;
                document.getElementById('editVenueName').value = venue.name;
                document.getElementById('editVenueLocation').value = venue.location;
                document.getElementById('editVenueModal').style.display = 'flex';
            }
        }

        async function saveVenueChanges(event) {
            event.preventDefault();
            const venueId = parseInt(document.getElementById('editVenueId').value);
            const venue = AppState.venues.find(v => v.id === venueId);
            if (venue) {
                venue.name = document.getElementById('editVenueName').value;
                venue.location = document.getElementById('editVenueLocation').value;
                closeModal('editVenueModal');
                await saveAllData();
                renderVenuesGrid();
                showToast('‚úÖ Venue updated');
            }
        }

        async function deleteVenue(venueId) {
            if (confirm('Delete this venue? All cocktails will be lost.')) {
                const index = AppState.venues.findIndex(v => v.id === venueId);
                if (index !== -1) {
                    AppState.venues.splice(index, 1);
                    await saveAllData();
                    renderVenuesGrid();
                    showToast('‚úÖ Venue deleted');
                }
            }
        }

        async function uploadVenueImage(venueId, event) {
            const file = event.target.files[0];
            if (file) {
                const path = `venues/${venueId}_${Date.now()}.jpg`;
                const url = await uploadImage(file, path);
                if (url) {
                    const venue = AppState.venues.find(v => v.id === venueId);
                    if (venue) {
                        venue.image = url;
                        await saveAllData();
                        renderVenuesGrid();
                        showToast(`‚úÖ ${venue.name} image updated`);
                    }
                }
            }
        }

        function openAddVenueModal() {
            const name = prompt('Enter venue name:');
            if (name) {
                const location = prompt('Enter location:');
                AppState.venues.push({
                    id: AppState.nextVenueId++,
                    name,
                    location: location || 'TBD',
                    image: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400',
                    order: AppState.venues.length + 1,
                    cocktails: []
                });
                renderVenuesGrid();
                saveAllData();
                showToast(`‚úÖ ${name} added`);
            }
        }

        // Cocktail Functions
        function openAddCocktailModalForVenue(venueId) {
            openAddCocktailModal();
            document.getElementById('venueSelectionField').style.display = 'none';
            document.getElementById('cocktailVenue').value = venueId;
        }

        function openAddCocktailModal() {
            document.getElementById('addCocktailModal').style.display = 'flex';
            populateVenueDropdown();
            document.getElementById('dilutionNone').checked = true;
            document.getElementById('ingredientTableBody').innerHTML = `
                <tr class="ingredient-row">
                    <td class="ingredient-search">
                        <input type="text" placeholder="Search or type ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                        <div class="autocomplete-list" id="autocomplete-0"></div>
                    </td>
                    <td><input type="number" placeholder="750" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td>
                        <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                            <option value="ml">ml</option>
                            <option value="dash">dash</option>
                        </select>
                    </td>
                    <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                    <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                    <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            calculateTotalPourCost();
            calculateFinalABV();
        }

        function openAddClassicCocktailModal() {
            openAddCocktailModal();
            document.getElementById('venueSelectionField').style.display = 'none';
        }

        async function saveNewCocktail(event) {
            event.preventDefault();
            
            // Get form data
            const venueId = parseInt(document.getElementById('cocktailVenue').value);
            const venue = AppState.venues.find(v => v.id === venueId);
            
            if (!venue) {
                showToast('‚ùå Please select a venue');
                return;
            }
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const unit = unitSelect?.value || 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    if (unit === 'dash') pourAmount *= DASH_TO_ML;
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit,
                        pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: row.dataset.spiritId || null
                    });
                }
            });
            
            const selected = document.querySelector('input[name="dilutionPreset"]:checked');
            const dilutionPreset = selected?.value || 'none';
            
            const finalAbv = calculateFinalABV();
            
            const newCocktail = {
                id: AppState.nextCocktailId++,
                name: document.getElementById('cocktailName').value,
                category: "signature",
                family: document.getElementById('cocktailFamily').value,
                favorite: false,
                image: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400",
                order: venue.cocktails.length + 1,
                recipe: recipe,
                pourCost: totalPourCost,
                sellingPrice: parseFloat(document.getElementById('cocktailSellingPrice').value),
                cogs: ((totalPourCost / parseFloat(document.getElementById('cocktailSellingPrice').value)) * 100).toFixed(1),
                finalAbv: finalAbv,
                method: document.getElementById('cocktailMethod').value,
                garnish: document.getElementById('cocktailGarnish').value,
                glassware: document.getElementById('cocktailGlass').value,
                dateAdded: new Date().toISOString().split('T')[0],
                author: "Bar Manager",
                dilutionPreset: dilutionPreset,
                notes: document.getElementById('cocktailNotes').value,
                batchSize: 1
            };
            
            venue.cocktails.push(newCocktail);
            
            closeModal('addCocktailModal');
            await saveAllData();
            selectVenue(venueId);
            showToast(`‚úÖ ${newCocktail.name} created`);
        }

        // Upload Cocktail Image
        async function uploadCocktailImage(venueId, cocktailId, event) {
            const file = event.target.files[0];
            if (file) {
                const path = `cocktails/${venueId}_${cocktailId}_${Date.now()}.jpg`;
                const url = await uploadImage(file, path);
                if (url) {
                    const venue = AppState.venues.find(v => v.id === venueId);
                    const cocktail = venue.cocktails.find(c => c.id === cocktailId);
                    if (cocktail) {
                        cocktail.image = url;
                        await saveAllData();
                        renderCocktailDetailPage(venueId, cocktailId);
                        showToast(`‚úÖ ${cocktail.name} image updated`);
                    }
                }
            }
        }

        // INFUSION
        function renderInfusionList() {
            const sorted = [...AppState.infusions].sort((a, b) => a.name.localeCompare(b.name));
            const filtered = AppState.infusionSearchTerm 
                ? sorted.filter(i => i.name.toLowerCase().includes(AppState.infusionSearchTerm.toLowerCase()))
                : sorted;
            
            const grouped = {};
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            alphabet.forEach(letter => grouped[letter] = filtered.filter(i => i.name.charAt(0).toUpperCase() === letter));

            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-flask"></i> Infusion Lab
                    </h1>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="openAddInfusionModal()">
                            <i class="fas fa-plus"></i> New Infusion
                        </button>
                    </div>
                </div>

                <div class="quick-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Quick search infusions..." id="infusionSearch" 
                           value="${AppState.infusionSearchTerm || ''}" onkeyup="filterInfusionList(this.value)">
                </div>

                <div class="alphabet-nav-container">
                    <div class="alphabet-content">
                        <div class="item-list">
                            ${alphabet.map(letter => {
                                const infusions = grouped[letter];
                                if (infusions?.length) return `
                                    <div id="infusion-letter-${letter}" style="margin-bottom: 1rem;">
                                        <div style="background: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 30px; display: inline-block; margin-bottom: 0.5rem; font-weight: 600;">
                                            ${letter} (${infusions.length})
                                        </div>
                                        ${infusions.map(infusion => `
                                            <div class="item-card" onclick="viewInfusionDetail(${infusion.id})">
                                                <div class="item-thumbnail">
                                                    <i class="fas fa-flask" style="font-size: 2rem; color: var(--accent);"></i>
                                                </div>
                                                <div class="item-info">
                                                    <div class="item-name">${infusion.name}</div>
                                                    <div class="item-meta">
                                                        <span><i class="fas fa-user"></i> ${infusion.author}</span>
                                                        <span><i class="fas fa-calendar"></i> ${infusion.date}</span>
                                                        <span><i class="fas fa-calculator"></i> ${infusion.ingredients.length} ingredients</span>
                                                        <span class="item-badge">$${infusion.totalPourCost.toFixed(2)}</span>
                                                    </div>
                                                    <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.875rem;">
                                                        Total Pour: ${infusion.totalPour}ml
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                                return '';
                            }).join('')}
                            ${!filtered.length ? `
                                <div style="background: var(--white); border-radius: 20px; padding: 3rem; text-align: center;">
                                    <i class="fas fa-flask" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                                    <h3 style="color: var(--primary); margin-bottom: 0.5rem;">No Infusions Found</h3>
                                    <p style="color: var(--gray); margin-bottom: 1.5rem;">${AppState.infusionSearchTerm ? 'Try a different search term' : 'Create your first infusion by clicking the button above.'}</p>
                                    <button class="btn btn-primary" onclick="openAddInfusionModal()">
                                        <i class="fas fa-plus"></i> Create Infusion
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="alphabet-nav">
                        ${alphabet.map(letter => {
                            const hasItems = grouped[letter]?.length > 0;
                            return `
                                <div class="alphabet-letter ${hasItems ? '' : 'disabled'}" 
                                     onclick="${hasItems ? `document.getElementById('infusion-letter-${letter}')?.scrollIntoView({behavior: 'smooth'})` : ''}">
                                    ${letter}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // View Infusion Detail
        function viewInfusionDetail(infusionId) {
            const infusion = AppState.infusions.find(i => i.id === infusionId);
            if (!infusion) return;
            
            showToast(`Viewing ${infusion.name}`);
        }

        function filterInfusionList(searchTerm) {
            AppState.infusionSearchTerm = searchTerm;
            renderInfusionList();
        }

        // DISTILLATION
        function renderDistillationList() {
            const sorted = [...AppState.distillations].sort((a, b) => a.name.localeCompare(b.name));
            const filtered = AppState.distillationSearchTerm 
                ? sorted.filter(d => d.name.toLowerCase().includes(AppState.distillationSearchTerm.toLowerCase()))
                : sorted;
            
            const grouped = {};
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            alphabet.forEach(letter => grouped[letter] = filtered.filter(d => d.name.charAt(0).toUpperCase() === letter));

            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-wine-bottle"></i> Distillation
                    </h1>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div id="syncStatus" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button class="btn btn-primary" onclick="openAddDistillationModal()">
                            <i class="fas fa-plus"></i> New Distillation
                        </button>
                    </div>
                </div>

                <div class="quick-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Quick search distillations..." id="distillationSearch" 
                           value="${AppState.distillationSearchTerm || ''}" onkeyup="filterDistillationList(this.value)">
                </div>

                <div class="alphabet-nav-container">
                    <div class="alphabet-content">
                        <div class="item-list">
                            ${alphabet.map(letter => {
                                const distillations = grouped[letter];
                                if (distillations?.length) return `
                                    <div id="distillation-letter-${letter}" style="margin-bottom: 1rem;">
                                        <div style="background: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 30px; display: inline-block; margin-bottom: 0.5rem; font-weight: 600;">
                                            ${letter} (${distillations.length})
                                        </div>
                                        ${distillations.map(distillation => `
                                            <div class="item-card" onclick="viewDistillationDetail(${distillation.id})">
                                                <div class="item-thumbnail">
                                                    <i class="fas fa-wine-bottle" style="font-size: 2rem; color: var(--accent);"></i>
                                                </div>
                                                <div class="item-info">
                                                    <div class="item-name">${distillation.name}</div>
                                                    <div class="item-meta">
                                                        <span><i class="fas fa-user"></i> ${distillation.author}</span>
                                                        <span><i class="fas fa-calendar"></i> ${distillation.date}</span>
                                                        <span><i class="fas fa-leaf"></i> ${distillation.botanicals.length} botanicals</span>
                                                        <span class="item-badge">$${distillation.totalPourCost.toFixed(2)}</span>
                                                    </div>
                                                    <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.875rem;">
                                                        Total Pour: ${distillation.totalPour}ml
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                                return '';
                            }).join('')}
                            ${!filtered.length ? `
                                <div style="background: var(--white); border-radius: 20px; padding: 3rem; text-align: center;">
                                    <i class="fas fa-wine-bottle" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                                    <h3 style="color: var(--primary); margin-bottom: 0.5rem;">No Distillations Found</h3>
                                    <p style="color: var(--gray); margin-bottom: 1.5rem;">${AppState.distillationSearchTerm ? 'Try a different search term' : 'Create your first distillation by clicking the button above.'}</p>
                                    <button class="btn btn-primary" onclick="openAddDistillationModal()">
                                        <i class="fas fa-plus"></i> Create Distillation
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="alphabet-nav">
                        ${alphabet.map(letter => {
                            const hasItems = grouped[letter]?.length > 0;
                            return `
                                <div class="alphabet-letter ${hasItems ? '' : 'disabled'}" 
                                     onclick="${hasItems ? `document.getElementById('distillation-letter-${letter}')?.scrollIntoView({behavior: 'smooth'})` : ''}">
                                    ${letter}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // View Distillation Detail
        function viewDistillationDetail(distillationId) {
            const distillation = AppState.distillations.find(d => d.id === distillationId);
            if (!distillation) return;
            
            showToast(`Viewing ${distillation.name}`);
        }

        function filterDistillationList(searchTerm) {
            AppState.distillationSearchTerm = searchTerm;
            renderDistillationList();
        }

        // Infusion Functions
        function openAddInfusionModal() {
            const modal = document.getElementById('addInfusionModal');
            document.getElementById('newInfusionForm').reset();
            document.getElementById('infusionIngredientTableBody').innerHTML = `
                <tr class="infusion-ingredient-row">
                    <td><input type="text" placeholder="Ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="500" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-pour-cost"></td>
                    <td><input type="number" placeholder="47" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionTotalABV(this)" required></td>
                    <td><button type="button" onclick="removeInfusionIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            document.getElementById('infusionTotalPour').value = '0';
            document.getElementById('infusionTotalPourCost').value = '0.00';
            document.getElementById('infusionDate').value = new Date().toLocaleDateString();
            modal.style.display = 'flex';
        }

        function addInfusionIngredientRow() {
            const tbody = document.getElementById('infusionIngredientTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'infusion-ingredient-row';
            newRow.innerHTML = `
                <td><input type="text" placeholder="Ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="500" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-pour-cost"></td>
                <td><input type="number" placeholder="47" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionTotalABV(this)" required></td>
                <td><button type="button" onclick="removeInfusionIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeInfusionIngredientRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                calculateInfusionTotals();
            } else {
                showToast('At least one ingredient is required');
            }
        }

        function calculateInfusionIngredientCost(input) {
            const row = input.closest('tr');
            const bottleSize = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const bottleCost = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
            row.cells[4].querySelector('input').value = pourCost.toFixed(3);
            calculateInfusionTotals();
        }

        function calculateInfusionTotalABV(input) {
            const row = input.closest('tr');
            const abv = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            row.cells[6].querySelector('input').value = (abv * pour / 100).toFixed(2);
            calculateInfusionTotals();
        }

        function calculateInfusionTotals() {
            const rows = document.querySelectorAll('#infusionIngredientTableBody .infusion-ingredient-row');
            let totalPour = 0, totalPourCost = 0;
            rows.forEach(row => {
                totalPour += parseFloat(row.cells[3].querySelector('input').value) || 0;
                totalPourCost += parseFloat(row.cells[4].querySelector('input').value) || 0;
            });
            document.getElementById('infusionTotalPour').value = totalPour.toFixed(1);
            document.getElementById('infusionTotalPourCost').value = totalPourCost.toFixed(2);
        }

        async function saveNewInfusion(event) {
            event.preventDefault();
            const rows = document.querySelectorAll('#infusionIngredientTableBody .infusion-ingredient-row');
            const ingredients = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    ingredients.push({
                        ingredient: inputs[0].value,
                        volume: parseFloat(inputs[1].value),
                        cost: parseFloat(inputs[2].value),
                        pour: parseFloat(inputs[3].value),
                        pourCost: parseFloat(inputs[4].value),
                        abv: parseFloat(inputs[5].value) || 0
                    });
                }
            });
            const newInfusion = {
                id: AppState.nextInfusionId++,
                name: document.getElementById('infusionName').value,
                author: document.getElementById('infusionAuthor').value,
                date: document.getElementById('infusionDate').value,
                ingredients,
                totalPour: parseFloat(document.getElementById('infusionTotalPour').value),
                totalPourCost: parseFloat(document.getElementById('infusionTotalPourCost').value),
                instructions: document.getElementById('infusionInstructions').value,
                allergens: document.getElementById('infusionAllergens').value,
                notes: document.getElementById('infusionNotes').value,
                progress: 0,
                created: new Date().toISOString().split('T')[0]
            };
            AppState.infusions.push(newInfusion);
            closeModal('addInfusionModal');
            await saveAllData();
            renderInfusionList();
            showToast(`‚úÖ ${newInfusion.name} infusion created`);
        }

        // Distillation Functions
        function openAddDistillationModal() {
            const modal = document.getElementById('addDistillationModal');
            document.getElementById('newDistillationForm').reset();
            document.getElementById('distillationIngredientTableBody').innerHTML = `
                <tr class="distillation-ingredient-row">
                    <td><input type="text" placeholder="Juniper" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="1000" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="30" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-pour-cost"></td>
                    <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationTotalABV(this)" required></td>
                    <td><button type="button" onclick="removeDistillationIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            document.getElementById('distillationTotalPour').value = '0';
            document.getElementById('distillationTotalPourCost').value = '0.00';
            document.getElementById('distillationDate').value = new Date().toLocaleDateString();
            modal.style.display = 'flex';
        }

        function addDistillationIngredientRow() {
            const tbody = document.getElementById('distillationIngredientTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'distillation-ingredient-row';
            newRow.innerHTML = `
                <td><input type="text" placeholder="Botanical" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="1000" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="30" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-pour-cost"></td>
                <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationTotalABV(this)" required></td>
                <td><button type="button" onclick="removeDistillationIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeDistillationIngredientRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                calculateDistillationTotals();
            } else {
                showToast('At least one botanical is required');
            }
        }

        function calculateDistillationIngredientCost(input) {
            const row = input.closest('tr');
            const bottleSize = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const bottleCost = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
            row.cells[4].querySelector('input').value = pourCost.toFixed(3);
            calculateDistillationTotals();
        }

        function calculateDistillationTotalABV(input) {
            const row = input.closest('tr');
            const abv = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            row.cells[6].querySelector('input').value = (abv * pour / 100).toFixed(2);
            calculateDistillationTotals();
        }

        function calculateDistillationTotals() {
            const rows = document.querySelectorAll('#distillationIngredientTableBody .distillation-ingredient-row');
            let totalPour = 0, totalPourCost = 0;
            rows.forEach(row => {
                totalPour += parseFloat(row.cells[3].querySelector('input').value) || 0;
                totalPourCost += parseFloat(row.cells[4].querySelector('input').value) || 0;
            });
            document.getElementById('distillationTotalPour').value = totalPour.toFixed(1);
            document.getElementById('distillationTotalPourCost').value = totalPourCost.toFixed(2);
        }

        async function saveNewDistillation(event) {
            event.preventDefault();
            const rows = document.querySelectorAll('#distillationIngredientTableBody .distillation-ingredient-row');
            const botanicals = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    botanicals.push({
                        ingredient: inputs[0].value,
                        volume: parseFloat(inputs[1].value),
                        cost: parseFloat(inputs[2].value),
                        pour: parseFloat(inputs[3].value),
                        pourCost: parseFloat(inputs[4].value),
                        abv: parseFloat(inputs[5].value) || 0
                    });
                }
            });
            const newDistillation = {
                id: AppState.nextDistillationId++,
                name: document.getElementById('distillationName').value,
                author: document.getElementById('distillationAuthor').value,
                date: document.getElementById('distillationDate').value,
                botanicals,
                totalPour: parseFloat(document.getElementById('distillationTotalPour').value),
                totalPourCost: parseFloat(document.getElementById('distillationTotalPourCost').value),
                instructions: document.getElementById('distillationInstructions').value,
                allergens: document.getElementById('distillationAllergens').value,
                notes: document.getElementById('distillationNotes').value,
                progress: 0,
                created: new Date().toISOString().split('T')[0]
            };
            AppState.distillations.push(newDistillation);
            closeModal('addDistillationModal');
            await saveAllData();
            renderDistillationList();
            showToast(`‚úÖ ${newDistillation.name} distillation created`);
        }

        // Ingredient Functions
        function calculateIngredientCost(input) {
            const row = input.closest('tr');
            const bottleSize = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const bottleCost = parseFloat(row.cells[2].querySelector('input').value) || 0;
            let pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const unitSelect = row.querySelector('select');
            if (unitSelect?.value === 'dash') pour *= DASH_TO_ML;
            const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
            row.cells[5].querySelector('input').value = pourCost.toFixed(3);
            calculateTotalPourCost();
            calculateFinalABV();
        }

        function calculateIngredientABV() {
            calculateFinalABV();
        }

        function calculateTotalPourCost() {
            const inputs = document.querySelectorAll('.pour-cost');
            let total = 0;
            inputs.forEach(input => total += parseFloat(input.value) || 0);
            document.getElementById('cocktailCostPrice').value = total.toFixed(2);
        }

        function calculateCOGS() {}

        function calculateFinalABV() {
            const rows = document.querySelectorAll('.ingredient-row');
            let totalAlcohol = 0, totalVolume = 0;
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[3].value && inputs[6].value) {
                    let amount = parseFloat(inputs[3].value) || 0;
                    if (unitSelect?.value === 'dash') amount *= DASH_TO_ML;
                    const abv = parseFloat(inputs[6].value) || 0;
                    totalAlcohol += amount * (abv / 100);
                    totalVolume += amount;
                }
            });
            const selected = document.querySelector('input[name="dilutionPreset"]:checked');
            let dilution = selected ? (AppState.dilutionPresets[selected.value] || 0) : 0;
            const useCustom = document.getElementById('useCustomDilution');
            if (useCustom?.checked) {
                const custom = document.getElementById('customDilutionValue');
                if (custom?.value) dilution = parseFloat(custom.value) / 100;
            }
            const finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilution) * 100 : 0;
            document.getElementById('finalAbvValue').textContent = `${finalAbv.toFixed(1)}%`;
            return finalAbv;
        }

        function addIngredientRow() {
            const tbody = document.getElementById('ingredientTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'ingredient-row';
            newRow.innerHTML = `
                <td class="ingredient-search">
                    <input type="text" placeholder="Search or type ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                    <div class="autocomplete-list" id="autocomplete-${Date.now()}"></div>
                </td>
                <td><input type="number" placeholder="750" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                <td><input type="number" placeholder="25" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                <td>
                    <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                        <option value="ml">ml</option>
                        <option value="dash">dash</option>
                    </select>
                </td>
                <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeIngredientRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                calculateTotalPourCost();
                calculateFinalABV();
            } else {
                showToast('At least one ingredient is required');
            }
        }

        // Show Ingredient Reference
        function showIngredientReference(spiritId, ingredientName) {
            if (!spiritId) {
                showToast('No spirit library reference for this ingredient');
                return;
            }
            const spirit = AppState.spiritLibrary.find(s => s.id === spiritId);
            if (spirit) {
                showToast(`üìã ${spirit.name} - ${spirit.abv}% ABV, $${spirit.bottleCost.toFixed(2)} per ${spirit.bottleSize}ml`);
            }
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleCustomDilution() {
            const checkbox = document.getElementById('useCustomDilution');
            const customInput = document.getElementById('customDilutionValue');
            if (checkbox.checked) {
                customInput.style.display = 'block';
                customInput.disabled = false;
            } else {
                customInput.style.display = 'none';
                customInput.disabled = true;
            }
        }

        // Toast
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Update Favorites List
        function updateFavoritesList() {
            const favoritesList = document.getElementById('favoritesList');
            if (favoritesList) {
                const favorites = AppState.venues.flatMap(v => v.cocktails.filter(c => c.favorite));
                favoritesList.innerHTML = favorites.map(cocktail => {
                    const venue = AppState.venues.find(v => v.cocktails.includes(cocktail));
                    return `
                        <div class="nav-item" onclick="viewCocktailDetail(${venue.id}, ${cocktail.id})">
                            <i class="fas fa-cocktail"></i>
                            <div style="display: flex; flex-direction: column;">
                                <span>${cocktail.name}</span>
                                <span style="font-size: 0.7rem; color: var(--accent);">${venue.name}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Initialize
        populateVenueDropdown();
        loadAllData().then(() => {
            renderDashboard();
            updateFavoritesList();
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
            if (event.target.classList.contains('spirit-edit-modal')) event.target.style.display = 'none';
            if (event.target.classList.contains('pdf-preview-modal')) event.target.style.display = 'none';
        };
    </script>
</body>
</html>
